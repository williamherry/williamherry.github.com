
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>William's Blog with Octopress</title>
  <meta name="author" content="William Herry">

  
  <meta name="description" content="从Android 3.0(API Level 11)开始,Android加入了一个新的API, ActionBar.但目前市面上还有好多的Android 2.3(API Level 8),并不支持ActionBar,还好有人开发了ActionBarSherlock可以让2. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://williamherry.github.com/blog/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="William's Blog with Octopress" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


<!-- this font looks great -->
<link href='http://fonts.googleapis.com/css?family=Delius' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">William's Blog with Octopress</a></h1>
  
    <h2>Octopress is A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:williamherry.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/27/actionbarsherlock-setup/">ActionBarSherlock使用</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-27T21:50:00+08:00" pubdate data-updated="true">May 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/27/actionbarsherlock-setup/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>从Android 3.0(API Level 11)开始,Android加入了一个新的API, ActionBar.但目前市面上还有好多的Android 2.3(API Level 8),并不支持ActionBar,还好有人开发了ActionBarSherlock可以让2.x的系统也能使用ActionBar,而且它有一个特点,如果你在3.0以上的机子上使用,那么它会调用系统原生的ActionBar.这里简单记录一下设置过程.</p>

<p>首先从<a href="http://actionbarsherlock.com/">官方网站</a>上下载压缩包</p>

<p>解开里面会有一个actionbarsherlock的目录,在eclipse中导入这个项目(eclipse中file -> new -> other -> android类下的android project from existing code,选择解压开的actionbarsherlock目录)</p>

<p>导入之后会多了一个名为actionbarsherlock的项目</p>

<p>然后在你要使用ActionBarSherlock的项目名字上右键选择properties,弹出的窗口中点击左边的Android标签,然后点击add选择刚才导入的项目</p>

<p>完成后就可以在项目中使用ActionBarSherlock了</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/13/understand-stub-and-mock/">理解测试中的stub和mock</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-13T16:46:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/13/understand-stub-and-mock/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>刚开始学习<code>rspec</code>的时候,<code>stub</code>和<code>mock</code>理解起来有点困难,听了<code>Terry</code>和<code>aNdReW</code>的讲解后,对它们的理解深入多了,在此表示感谢</p>

<p>先从<code>stub</code>说起,什么是<code>stub</code>呢,<code>CodeSchool</code>给出这样的定义:</p>

<blockquote><p>Stub:<br/>
For replacing a method with code that returns a specified result</p></blockquote>

<p>简单说就是你可以用<code>stub</code>去<strong>伪造(fade)</strong>一个方法,<strong>阻断</strong>对原来方法的调用,例如下面来自<code>CodeSchool</code>的例子</p>

<p>我们有一个叫<code>zombie</code>的<code>model</code></p>

<figure class='code'><figcaption><span>app/models/zombie.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Zombie</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">has_one</span> <span class="ss">:weapon</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">decapitate</span>
</span><span class='line'>    <span class="n">weapon</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:head</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;dead again&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们要测试<code>decapitate</code>方法,它里面调用了<code>weapon</code>的<code>slice</code>方法,下面是测试代码:</p>

<figure class='code'><figcaption><span>/spec/models/zombie_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Zombie</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:zombie</span><span class="p">)</span> <span class="p">{</span> <span class="no">Zombie</span><span class="o">.</span><span class="n">create</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;#decapitate&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;sets status to dead again&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">zombie</span><span class="o">.</span><span class="n">weapon</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:slice</span><span class="p">)</span>
</span><span class='line'>      <span class="n">zombie</span><span class="o">.</span><span class="n">decapitate</span>
</span><span class='line'>      <span class="n">zombie</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;dead again&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面代码的第6行就是用<code>stub</code>伪造了<code>weapon</code>的<code>slice</code>方法,阻断了对原来方法的调用</p>

<p>你可能会问为什么我们要这样做,这是因为我们在做单元测试,<code>weapon</code>的<code>slice</code>可能会非常复杂,里面又调用了其它的方法等等,这是集成测试应该做的工作.事实上这里我们是在测试<code>decapitate</code>方法会把<code>zombie.status</code>设置成<code>"dead again"</code></p>

<p>接下来我们来说<code>mock</code>, <code>CodeSchool</code>上给的定义是这样的:</p>

<blockquote><p>Mock:<br/>
A stub with an expectations that the method gets called.</p></blockquote>

<p>简单来说<code>mock</code>就是<code>stub + expectation</code>, 说它是<code>stub</code>是因为它也可以像<code>stub</code>一样伪造方法,阻断对原来方法的调用, <code>expectation</code>是说它不仅伪造了这个方法,它还期望你(必须)调用这个方法,如果没有被调用到,这个<code>test</code>就<code>fail</code>了,看下面的例子</p>

<figure class='code'><figcaption><span>/spec/models/zombie_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Zombie</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:zombie</span><span class="p">)</span> <span class="p">{</span> <span class="no">Zombie</span><span class="o">.</span><span class="n">create</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;#decapitate&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;calls weapon.slice&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">zombie</span><span class="o">.</span><span class="n">weapon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:slice</span><span class="p">)</span>
</span><span class='line'>      <span class="n">zombie</span><span class="o">.</span><span class="n">decapitate</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的第6行伪造了<code>weapon</code>的<code>slice</code>方法,并期望这个方法在这个测试中被调用.</p>

<p>你可能会想为什么要这样写,这是因为我们仅仅是要测试<code>decapitate</code>这个方法确实调用了<code>weapon.slice</code>, 可以把<code>decapitate</code>想成下面的黑盒,我们蹲在图中的A点,等着看它会不会去调用<code>weapon.slice</code></p>

<p><img src="/images/test/test_outgoing.jpg"></p>

<p>这个图是<code>Sandi Metz</code>在<code>RailsConf 2013</code>上的演讲<code>The Magic Tricks of Testing</code></p>

<p><a href="http://www.justin.tv/confreaks/c/2247122">视频</a></p>

<p><a href="https://speakerdeck.com/skmetz/magic-tricks-of-testing-railsconf">Slides</a></p>

<p>这里注意一下顺序,一般的测试先是执行一个动作,然后再去判断状态或其它东西,像前面<code>stub</code>的例子,先调用decapitate方法,再去判断<code>status</code>的变化,就好像我踢你一脚,看你会不会喊疼,而这里是先有期望再有动作,这就好比老板对你说这个下周前完成,不然就滚蛋一样</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/23/opensuse-12-dot-3-font-configuration/">openSUSE 12.3 安装完后需要做的事情</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-23T02:36:00+08:00" pubdate data-updated="true">Mar 23<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/03/23/opensuse-12-dot-3-font-configuration/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今天终于把openSUSE12.3安装上了,记得上次安装openSUSE应该是好几年前吧,那时候刚开始玩Linux.记得当时选发行版的时候很纠结,老想用openSUSE但当时它还是有很多问题,尤其严重的是显示上有点问题,图形界面和字符界面不能同时和显示器边对齐,以当时的水平解决不了这个问题,就放弃而一直用的Ubuntu</p>

<p>今天安装上了最新的12.3,比以前进步太多了,fcitx输入法安装就能用(以前很麻烦的,尤其是环境是英文的),各种驱动自动帮你安好,进系统就可以开启3D,KDE4.10已经非常稳定了,不像以前动不动就Crash. 总的来说我非常满意,以后就用她了</p>

<p>不过openSUSE 12.3的默认字体还是非常难看的,需要做一些配置才可以让人看着舒服</p>

<p>其实根本的问题并不是没有好看的字体,而是字体的渲染不给力,使字体看起来很虚,锯齿很厉害,我从网上找的这个办法可以开启抗锯齿,分享给大家</p>

<p>原文地址在<a href="http://tuxperience.blogspot.com/2012/12/fix-ugly-fonts-in-kubuntu-or-kde-make.html">这里</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Fix: Ugly Fonts in Kubuntu or KDE | Make your fonts crystal clear
</span><span class='line'>
</span><span class='line'>By default, KDE Desktop and Kubuntu have a very ugly font behavior compared to GNOME or Ubuntu. But no worries. Fix is easy!
</span><span class='line'>
</span><span class='line'>How to fix it?
</span><span class='line'>
</span><span class='line'>1- Go to "System Settings &gt; Application Appearance &gt; Fonts"
</span><span class='line'>2- Enable anti-ailising.
</span><span class='line'>3- Set Use sub-pixel rendering to RGB and Slight.
</span><span class='line'>4- Go Advanced tab of Desktop Effects and set scale method to Crisp.
</span><span class='line'>
</span><span class='line'>To improve your fonts more, change your fonts to DejaVu and for a better console set console fonts to DejaVu Sans Mono 9.5.
</span><span class='line'>
</span><span class='line'>Now you have very cyrstal looking fonts! Have fun!</span></code></pre></td></tr></table></div></figure>


<p>我刚开始照他的做也看不到效果的,花了好长时间,发现一个很有意思的事情,就是把字体放大到16以后和缩小到8以后字体的渲染开始变得非常漂亮,后来才发现在第三步设置anti-ailising的时候点击后面的configure在弹出的窗口中有<code>Exclude range</code>正好是8和16,我是勾选了的,原来我把8到16之间的字体除过不渲染,去掉之后漂亮的字体终于出来了.现在你可以随便选择你喜欢的字体,都会有很好的效果</p>

<p>PS: 这些文字就是在新的openSUSE 12.3下面写的,看来以后要和Ubuntu说再见了</p>

<p>UPDATE: 无线网络的问题</p>

<p>Release Note中有说安装完无线网没有启动,需要手机重启系统,但是我发现我还遇到一个问题,有时候开机无线网络是没有连上了,点开直接是空的,我在<a href="http://forums.opensuse.org/english/get-technical-help-here/network-internet/470567-wireless-problems-opensuse-12-1-a.html">这里</a>找到了解决办法,简单说就是默认他用的<code>dhcpd</code>好像不太稳定,改成<code>dhclient</code>就好了</p>

<p>在<code>/etc/sysconfig/network/dhcp</code>中修改下面两行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DHCLIENT_BIN="dhclient"
</span><span class='line'>DHCLIENT_DEBUG="yes"</span></code></pre></td></tr></table></div></figure>


<p>加第二行是因为有一个<a href="https://bugzilla.novell.com/show_bug.cgi?id=732910">bug</a> (不过好像已经修复了)</p>

<p>UPDATE2: 支付宝插件</p>

<p>需要安装<code>libpng12-0</code>才可以使支付宝的插件安装成功,不然它提示成功但却用不了</p>

<p>UPDATE3: 无线网硬件禁用的问题</p>

<p>从sleep状态resume后无线网会是硬件禁用状态,需要手动按<code>Fn + F3</code>开启,后来发现是驱动冲突,在<code>/etc/modprobe.d/50-blacklist.conf</code>中的最后加上<code>blacklist acer-wmi</code>就好了</p>

<p>还有一直让我很迷惑的<code>Magic Lamp</code>的问题,我很早就发现这个特效会有两种不同的效果,有时会最小化收到状态栏,有时会收到鼠标的位置,后来才知道原来收到鼠标的位置是一种fallback的情形,有的时候收到状态栏不可用,比如程序刚启动的时候,状态栏还没有调整好,这时候这个特效就会收到鼠标的位置</p>

<p>还有默认的配置如果你一段时间不操作电脑,他会出现输入密码的登陆的画面,但只要你动一下鼠标或键盘就消失了,我看的一个youtube上的视频上还有人说这是个bug,其实不是,这只是它的默认屏保画面而已</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/05/rvm-rake-cron-ubuntu/">最简单的在crontab中执行rake命令的方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-05T11:26:00+08:00" pubdate data-updated="true">Feb 5<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/05/rvm-rake-cron-ubuntu/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>stackoverflow上很多都说要添加变量什么的,这是我发现的最简单而且能工作的方法,原文在<a href="http://www.wyliethomas.com/blog/2011/08/24/rvm-rake-and-cron-on-ubuntu/">这里</a></p>

<p>方法很简单,在crontab中可以定义环境变量</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crontab -e</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SHELL = /home/william/.rvm/bin/rvm-shell
</span><span class='line'>
</span><span class='line'>* 4 * * * /bin/bash -l -c 'cd /path/to/app && RAILS_ENV=production rake mytask –silent'</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/25/rails-image-upload/">Rails图片上传</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-25T22:27:00+08:00" pubdate data-updated="true">Jan 25<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/01/25/rails-image-upload/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>好久没有更新这个了,竟然连<code>rake new_post['title']</code>都忘记了还得查文档,看来以后还是得时不时的写点</p>

<p>这里简单记录一下Rails中如何处理图片上传,我们选择<a href="https://github.com/jnicklas/carrierwave">CarrierWave</a>这个gem来处理上传的文件,由于重点是处理图片上传,所以我们会使用scaffolding生成一个article的CURD,把图片绑定给它(一个article有一个图片)</p>

<p>首先我们创建一个Rails项目</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new image-upload-demo</span></code></pre></td></tr></table></div></figure>


<p>然后用脚手架生成article</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd image-upload-demo
</span><span class='line'>rails g scaffold article title:string content:text</span></code></pre></td></tr></table></div></figure>


<p>执行migration生成数据库表结构</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure>


<p><code>rails s</code>启动服务,访问<code>http://localhost:3000/articles</code>检查有没错误</p>

<p>如果没有问题,下一步我们就可以设定CarrierWave了,首先是安装,在Gemfile里添加一行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'carrierwave'</span></code></pre></td></tr></table></div></figure>


<p>然后执行<code>bundle install</code>进行安装,然后用下面的命令创建uploader</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g uploader photo</span></code></pre></td></tr></table></div></figure>


<p>这会创建<code>app/uploaders/photo_uploader.rb</code>这个文件,carrierwave的一些设定都在这个文件里面,我们目前先不做更改,只使用默认配置</p>

<p>接着我们给article表加一个字段来存储文件信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g migration AddPhotoToArticles photo:string</span></code></pre></td></tr></table></div></figure>


<p>别忘了执行<code>rake db:migrate</code>生成表结构</p>

<p>然后的article的model里加入调用carrierwave的代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># app/models/article.rb
</span><span class='line'>class Article &lt; ActiveRecord::Base
</span><span class='line'>  attr_accessible :content, :title, :photo
</span><span class='line'>
</span><span class='line'>  mount_uploader :photo, PhotoUploader
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>别忘了把<code>photo</code>也加到<code>attr_accessible</code>里哦
这样Model和数据库就可以处理上传上来的文件了,接下来在view里加入上传图片的代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># app/views/articles/_form.html.erb
</span><span class='line'>&lt;%= form_for(@article, :html =&gt; {:multipart =&gt; true}) do |f| %&gt;
</span><span class='line'>...
</span><span class='line'>  &lt;div class="field"&gt;
</span><span class='line'>    &lt;%= f.label :title %&gt;&lt;br /&gt;
</span><span class='line'>    &lt;%= f.text_field :title %&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>  &lt;div class="field"&gt;
</span><span class='line'>    &lt;%= f.label :content %&gt;&lt;br /&gt;
</span><span class='line'>    &lt;%= f.text_area :content %&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>  &lt;div class="field"&gt;
</span><span class='line'>    &lt;label&gt;My Photo&lt;/label&gt;
</span><span class='line'>    &lt;%= f.file_field :photo %&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>  &lt;div class="actions"&gt;
</span><span class='line'>    &lt;%= f.submit %&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>关键在form_for中添加<code>:html =&gt; {:multipart =&gt; true}</code>,现在就可以使用上传的功能了,并且上传的图片可以简单的使用<code>&lt;%= image_tag @article.photo %&gt;</code>来调用,我们再在显示的view里加入显示图片的代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># app/views/articles/show.html.erb
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span><span class='line'>  &lt;b&gt;Photo:&lt;/b&gt;
</span><span class='line'>  &lt;%= image_tag @article.photo %&gt;
</span><span class='line'>&lt;/p&gt;
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>现在就可以测试了</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/12/proxy-chef-server-with-nginx/">使用Nginx+SSL代理chef-server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-12T21:09:00+08:00" pubdate data-updated="true">Oct 12<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/10/12/proxy-chef-server-with-nginx/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>说明</h2>

<p>本文介绍使用Nginx做为chef-server的前端代理服务器,并使用SSL加密传输数据</p>

<p>这里使用的系统是centos,应该也适用于其它的发行版</p>

<p>这里假设你已经配置好了chef-server,在整个过程中都不需要对chef-server做修改(你可能会想到让chef-server只监听在127.0.0.1上)</p>

<h2>安装Nginx</h2>

<pre><code>yum -y install nginx
</code></pre>

<h2>生成自签名证书</h2>

<pre><code>mkdir -p /etc/ssl/nginx
cd /etc/ssl/nginx
openssl genrsa -out chef-server.pem 2048
openssl req -new -x509 -key chef-server.pem -out chef-server.crt -days 1095 # 回车后按提示填一堆乱七八糟的东西
</code></pre>

<h2>修改nginx配置文件</h2>

<p>这里有一个例子(注意key的路径以及server_name直接写IP地址)</p>

<figure class='code'><figcaption><span>vim</span><a href='/etc/nginx/nginx.conf'>link</a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#######################################################################</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This is the main Nginx configuration file.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># More information about the configuration options is available on</span>
</span><span class='line'><span class="c">#   * the English wiki - http://wiki.nginx.org/Main</span>
</span><span class='line'><span class="c">#   * the Russian documentation - http://sysoev.ru/nginx/</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#######################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="c">#----------------------------------------------------------------------</span>
</span><span class='line'><span class="c"># Main Module - directives that cover basic functionality</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#   http://wiki.nginx.org/NginxHttpMainModule</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#----------------------------------------------------------------------</span>
</span><span class='line'>
</span><span class='line'>user              nginx;
</span><span class='line'>worker_processes  1;
</span><span class='line'>
</span><span class='line'>error_log  /var/log/nginx/error.log;
</span><span class='line'><span class="c">#error_log  /var/log/nginx/error.log  notice;</span>
</span><span class='line'><span class="c">#error_log  /var/log/nginx/error.log  info;</span>
</span><span class='line'>
</span><span class='line'>pid        /var/run/nginx.pid;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#----------------------------------------------------------------------</span>
</span><span class='line'><span class="c"># Events Module</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#   http://wiki.nginx.org/NginxHttpEventsModule</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#----------------------------------------------------------------------</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections  1024;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#----------------------------------------------------------------------</span>
</span><span class='line'><span class="c"># HTTP Core Module</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#   http://wiki.nginx.org/NginxHttpCoreModule</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#----------------------------------------------------------------------</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>    include       /etc/nginx/mime.types;
</span><span class='line'>    default_type  application/octet-stream;
</span><span class='line'>
</span><span class='line'>    log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span>;
</span><span class='line'>
</span><span class='line'>    access_log  /var/log/nginx/access.log  main;
</span><span class='line'>
</span><span class='line'>    sendfile        on;
</span><span class='line'>    <span class="c">#tcp_nopush     on;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#keepalive_timeout  0;</span>
</span><span class='line'>    keepalive_timeout  65;
</span><span class='line'>
</span><span class='line'>    <span class="c">#gzip  on;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Load config files from the /etc/nginx/conf.d directory</span>
</span><span class='line'>    <span class="c"># The default server is in conf.d/default.conf</span>
</span><span class='line'>    include /etc/nginx/conf.d/*.conf;
</span><span class='line'>    upstream chef-server <span class="o">{</span>
</span><span class='line'>      server 127.0.0.1:4000;
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    server <span class="o">{</span>
</span><span class='line'>        listen 443 ssl;
</span><span class='line'>
</span><span class='line'>        server_name 192.168.122.44;
</span><span class='line'>        root /var/lib/chef/rack/api/public;
</span><span class='line'>
</span><span class='line'>        ssl_certificate     /etc/ssl/nginx/chef-server.crt;
</span><span class='line'>        ssl_certificate_key /etc/ssl/nginx/chef-server.key;
</span><span class='line'>
</span><span class='line'>        location / <span class="o">{</span>
</span><span class='line'>            try_files <span class="nv">$uri</span> @backend;
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location @backend <span class="o">{</span>
</span><span class='line'>            proxy_set_header X-Forwarded-Proto <span class="s1">&#39;https&#39;</span>;
</span><span class='line'>            proxy_set_header Host <span class="nv">$server_name</span>;
</span><span class='line'>            proxy_pass http://chef-server;
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>检查配置文件并启动服务</h2>

<pre><code>nginx -t
/etc/init.d/nginx start
</code></pre>

<h2>修改client使用新的地址</h2>

<figure class='code'><figcaption><span>vim</span><a href='/etc/chef/client.rb'>link</a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">chef_server_url</span>  <span class="s1">&#39;https://ip-of-chef-server&#39;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>vim ~/.chef/knife.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">chef_server_url</span>  <span class="s1">&#39;https://ip-of-chef-server&#39;</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/10/chef-attributes/">Chef基础之Arrtibutes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-10T21:42:00+08:00" pubdate data-updated="true">Oct 10<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/10/10/chef-attributes/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>本文档是对官方Wiki<a href="http://wiki.opscode.com/display/chef/Attributes">Attributes</a>的翻译</p>

<h2>概述</h2>

<p><img src="/images/chef/attributes.jpg"></p>

<p>属性(Attributes)就是节点(Node)的信息,如IP地址,主机名,加载的内核模块,系统中可用的编程语言的版本以及更多.新的属性可以用多种方式加到节点上.</p>

<h2>属性类型和优先级</h2>

<p><img src="/images/chef/attribute-priority-stack.png"></p>

<p>有四种类型的属性,按优先级从高到低的顺序排列,它们是:</p>

<ul>
<li>automatic</li>
<li>override</li>
<li>normal</li>
<li>default</li>
</ul>


<p><em>用默认属性(default)写你的cookbook, 如果有必要,在role或者node中覆盖默认变量</em></p>

<p>Chef没有提供任何方式去修改自动属性(automatic),因为Ohai下次运行的时候回覆盖你做的任何修改.检验<a href="http://wiki.opscode.com/display/chef/Automatic+Attributes">自动属性</a>看有那些保留的命名</p>

<h2>属性的持久性</h2>

<p><em>每一次chef-client运行的开始,默认属性,覆盖属性和自动属性会被完全重置</em></p>

<p>然后会利用当前的cookbooks, recipes, roles, environment和Ohai数据重新组建</p>

<p>所以,一量recipe, role或environment从一个node移除并且chef-client在这个node上运行,那么在cookbook的attribute文件,roles, recipes或environments里设置的default和override属性会消失</p>

<p><em>Normal属性不会被重置</em></p>

<p>而是,第一次chef-client运行,任何以JSON文件形式传递给node的新属性会被合并到node中已经存在的normal属性中(使用<a href="http://wiki.opscode.com/display/chef/Deep+Merge">Deep Merge</a>)</p>

<p>这就意味着,任何在recipe或cookbook中定义的normal属性会仍然存在,即使是cookbook或role已经从node的run list移除后</p>

<h2>设置属性</h2>

<p>属性可以在下面的对象中设置</p>

<ul>
<li>cookbooks</li>
<li>environments (Chef 0.10.0 or above only)</li>
<li>roles</li>
<li>nodes</li>
</ul>


<h3>优先级</h3>

<p><em>属性的优先级从低到高排列在下面</em></p>

<ul>
<li>attributes文件中定义的default属性</li>
<li>environment中定义的default属性</li>
<li>role中定义的default属性</li>
<li>直接在node的recipe中定义的default属性</li>
<li>attributes文件中定义的normal或set属性</li>
<li>直接在node的recipe中定义的normal或set属性</li>
<li>attributes文件中定义的override属性</li>
<li>role中定义的override属性</li>
<li>environment中定义的override属性</li>
<li>直接在node的recipe中定义的override属性</li>
<li>Ohai产生的automatic属性</li>
</ul>


<p>在attributes文件里定义的default属性有最低的优先级. Ohai生成的automatic属性有最高的优先级</p>

<p><em>用默认属性(default)写你的cookbook, 如果有必要,在role或者node中覆盖默认变量</em></p>

<p><a href="http://wiki.opscode.com/display/chef/Setting+Attributes+%28Examples%29">这里</a>有例子</p>

<h2>Cookbook中定义属性</h2>

<p>Cookbook的属性文件可以在cookbook的attributes子目录中找到.他们在Node对象的上下文中运算并且使用Node的方法设置属性的值</p>

<p>来自Oposcode的Apache cookbook中的例子</p>

<figure class='code'><figcaption><span>cookbooks/apache2/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;dir&quot;</span><span class="o">]</span>          <span class="o">=</span> <span class="s2">&quot;/etc/apache2&quot;</span>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;listen_ports&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;80&quot;</span><span class="p">,</span><span class="s2">&quot;443&quot;</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里Node对象的使用是隐含的,下面这样写和上面等价</p>

<figure class='code'><figcaption><span>cookbooks/apache2/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;dir&quot;</span><span class="o">]</span>          <span class="o">=</span> <span class="s2">&quot;/etc/apache2&quot;</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;listen_ports&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;80&quot;</span><span class="p">,</span><span class="s2">&quot;443&quot;</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>属性也可以在recipe中设置,但这时<code>node.</code>就不能省略了</p>

<h3>Cookbook设置属性的方法</h3>

<p>使用下面的方法在cookbook的attributes文件或recipe中设置属性.他们对应到和他们名字相同的属性类型(set是normal的一个别名)</p>

<ul>
<li>override</li>
<li>default</li>
<li>normal(or set)</li>
</ul>


<h3>Cookbook中属性文件的加载顺序</h3>

<p>Chef按字母顺序加载cookbook中的属性文件.如果你需要一个属性文件在另一个之前加载(例如,你的Apache的cookbook属性文件的加载需要在Rails的cookbook属性文件加载之后),你可以使用<code>include_attribute</code>方法.像这样:</p>

<figure class='code'><figcaption><span>include\_attribute  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_attribute</span> <span class="s2">&quot;rails&quot;</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;apache2&#39;</span><span class="o">][</span><span class="s1">&#39;proxy_to_unicorn&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;rails&#39;</span><span class="o">][</span><span class="s1">&#39;use_unicorn&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>这会在继续处理当前属性之前首先加载<code>rails/attributes/defaults.rb</code></p>

<p>双冒号的写法也适用于<code>include_attribute</code></p>

<figure class='code'><figcaption><span>include\_attribute  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_attribute</span> <span class="s2">&quot;rails::tunables&quot;</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;apache2&#39;</span><span class="o">][</span><span class="s1">&#39;proxy_to_unicorn&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;rails&#39;</span><span class="o">][</span><span class="s1">&#39;use_unicorn&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>这会加载rails cookbook中的<code>attributes/tunables.rb</code>文件</p>

<h3>从Recipes中重新加载Attribute文件</h3>

<p>有时候属性依赖于recipes中的动作,所以可能会需要在recipe中重新加载属性.例如,你有一个读防火墙规则的属性,并且有一个安装防火墙软件的recipe,第一次执行这个cookbook防火墙的属性不会被设置.因为<code>include_attribute</code>在recipes中不可用,所以你需要手动重新加载<code>firewall::default</code>属性</p>

<figure class='code'><figcaption><span>reloading attributes from recipes  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">package</span> <span class="s1">&#39;iptables&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;ruby_block[try_firewall_again]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">ruby_block</span> <span class="s1">&#39;try_firewall_again&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">block</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">load_attribute_by_short_filename</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;firewall&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:nothing</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>访问属性的方法</h3>

<p>属性访问方法会自动创建并且方法可以和键交换使用.下面的例子和上面的用法等价</p>

<figure class='code'><figcaption><span>cookbooks/apache2/attributes/default.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">dir</span>          <span class="o">=</span> <span class="s2">&quot;/etc/apache2&quot;</span>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">listen_ports</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;80&quot;</span><span class="p">,</span><span class="s2">&quot;443&quot;</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用哪个只是风格问题,你可能会在检索属性的值的时候看到</p>

<h2>Environment中设置属性</h2>

<p><em>Environment中可以设置default和override属性</em></p>

<p>这可以在Environment的Ruby DSL文件里(分别)通过default_attributes和<code>override_attributes</code>方法设置,或者在Environment的JSON数据中使用<code>default_attributes</code>和<code>override_attributes</code>Hashes进行设置.经常会指定一些这个Environment特别有属性.例如在&#8221;production&#8221;环境和&#8221;staging&#8221;环境外部负载均衡器的公共DNS可能会不一样</p>

<h2>在Role中定义属性</h2>

<p><em>在Role中只可以设置default和override属性,不能设置normal属性.</em>这可以在Role的Ruby DSL文件里(分别)通过<code>default_attributes</code>和<code>override_attributes</code>方法设置,或者在Role的JSON数据中使用<code>default_attributes</code>和<code>override_attributes</code>Hashes进行设置.经常会指定一些各个Role不同的属性.例如一个<code>php_apache2_server</code>的role可能会和<code>mod_perl_apche2_server</code>使用不同的优化参数</p>

<h2>在Node中定义属性</h2>

<p>最终,Node对象可以直接被修改以设置属性.通常会设置normal优先级的属性.可以通过使用knife工具直接编辑node,或者通过WebUI.或者通过传递JSON数据给Node进行设置</p>

<h3>JSON属性</h3>

<p>你可以使用JSON文件指定Node的属性,它们会以normal的优先级添加到Node</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef-client --help
</span><span class='line'>[...]
</span><span class='line'>    -j JSON_ATTRIBS                  Load attributes from a JSON file or URL
</span><span class='line'>        --json-attributes</span></code></pre></td></tr></table></div></figure>


<p>例如.设置Apache监听不同的端口</p>

<figure class='code'><figcaption><span>JSON attribute example  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span> <span class="nt">&quot;apache&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;listen_ports&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;81&quot;</span><span class="p">,</span> <span class="s2">&quot;8080&quot;</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>记住.通过JSON文件传递的属性会和Node已经保存的属性合并并且没有办法覆盖,但是如果有冲突,从JSON文件传递的属性会最终被使用</p>

<h3>Automatic属性</h3>

<p>这第四种属性不能被修改,因为你做的任何修改都会在下一次运行时被Ohai数据覆盖</p>

<h2>如果使用属性</h2>

<ul>
<li><p>属性的优势</p>

<ul>
<li>为应用程序跨平台的抽象例如配置文件的路径</li>
<li>优化参数的默认值例如给处理器多少内存或开启多少个进程</li>
<li>任何其它你想要在Chef运行之间保留(在Node的数据)的信息</li>
</ul>
</li>
</ul>


<h3>使用的最佳实践</h3>

<p><em>属性优先级的通用模式是在cookbooks和roles中使用default属性</em></p>

<ul>
<li>如果你要改变一个特定Node的值,使用normal属性</li>
<li>Overrides属性是指roles可以强制设定一个特定的属性,即使Node已经有相应的属性</li>
</ul>


<p>肯定有其它的使用方式,但上面的模式是设计的初衷</p>

<h3>设置同一优先级的属性</h3>

<p><em>一个通用的使用案例是在cookbook的attribute文件中设置default属性,并且在role中以不同的值设置相同的default属性.</em>在这种情况下,role中的属性会被<a href="http://wiki.opscode.com/display/chef/Deep+Merge">deep merged</a>到来自attribute文件中的属性顶端.如果有冲突,在role中设置的属性会被使用.</p>

<h3>只有在这个属性没有值的时候才设置</h3>

<p>在属性文件里,你也可以使用属性优先方法的变种<code>_unless</code>方法来做到只有在一个属性没有值时才设置这个属性,这些方法是<code>default_unless</code>, <code>set_unless</code>和<code>override_unless</code>.这些方法有时候非常方便,但要小心使用!</p>

<p>在你使用这些方法的时候,这些加到你的Node中的属性会和你在cookbooks中定义的不同步,当你更新cookbook的时候.这意味着建立一个和已经存在的Node使用相同的recipes和roles会得到不同的配置&#8211;会给调试带来麻烦.出于这个原因,你应该尽可能不用<code>_unless</code>方法</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/10/learning-git-resources/">Git学习资料收集</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-10T20:40:00+08:00" pubdate data-updated="true">Oct 10<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/10/10/learning-git-resources/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>收集一下学习Git过程中用过的比较好的资料</p>

<h2>ProGit</h2>

<p>首先是Github的Scott Chacon写的一本叫ProGit的书,已经有人翻译成中文了.可能大多数人学习Git就是从这本书开始的</p>

<p>中文版不知道有没有的买,英文版在亚马逊上的售价是357.90人民币.不过好在它可以在线读全部的内容,也可以下载pdf或其它流行的版本</p>

<p><a href="http://git-scm.com/book">英文版在线读地址</a></p>

<p><a href="http://ishare.iask.sina.com.cn/f/15315980.html">中文版下载地址</a></p>

<h2>Git权威指南</h2>

<p>还有一本国人写的书Git权威指南,比ProGit要深入全面,个人感觉值得一读.好像不能下载pdf版</p>

<p><a href="http://www.worldhello.net/gotgit/">Git权威指南</a></p>

<h2>Tech Talk: Linus Torvalds on Git</h2>

<p>Git的作者,Linux之父Linus在Google的演讲,在演讲中他说出了这样的霸气测露的话</p>

<blockquote><p>You can disagree with me as much as you want, but during this talk, by definition, anybody who disagrees is stupid and ugly, so keep that in mind</p></blockquote>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/4XpnKHJAok8 "></iframe></div>


<h2>Introduction to Git with Scott Chacon of GitHub</h2>

<p>这是ProGit的作者的演讲视频,语速很快,演讲用到的资料做的非常赞</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/ZDR433b0HJY "></iframe></div>


<h2>Advanced Git: Graphs, Hashes, and Compression, Oh My!</h2>

<p>这是GitHub的另一个员工做的演讲,里面讲了一些非常底层的东西</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/ig5E8CcdM9g "></iframe></div>


<h2>Git and Github</h2>

<p>这又是Github的另一个工程师的演讲视频,他里面用到一个小脚本可以让执行命令的同时看到变量,让人印象深刻.我还给他发邮件要这个小东西</p>

<p>由于嵌入vimeo然插件不工作了,点<a href="https://vimeo.com/49444883">这里</a>观看</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/09/chef-lwrp/">Chef基础之LWRP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-09T20:18:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/10/09/chef-lwrp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>概述</h2>

<p>Chef内置的Resources和Providers已经非常强大了,如果有些需求还不能满足,或者用内置的比较麻烦,这时可以编写自己的Resources和Providers</p>

<p>如果你看到别人的cookbook里有带有下画线的Resource,例如下面这个:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">apt_repository</span> <span class="s2">&quot;zenoss&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">uri</span> <span class="s2">&quot;http://dev.zenoss.org/deb&quot;</span>
</span><span class='line'>  <span class="n">components</span> <span class="o">[</span><span class="s2">&quot;main&quot;</span><span class="p">,</span><span class="s2">&quot;stable&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:add</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>那么它有可能就是一个一个Lightweight Resource.这里之所以说可能是因为还有其它的一些东西也是这种格式(以后会介绍到)</p>

<p>这个文档我们来看一下怎么写LWRP,主要是基本官方的Wiki,如果英文够好,可以直接看官方的,地址是: <a href="http://wiki.opscode.com/display/chef/Lightweight+Resources+and+Providers+%28LWRP%29">Lightweight Resources and Providers</a></p>

<p>在介绍LWRP之前我们先来回顾一下什么是Resource和Provider.简单来说Resource就是以一种抽象的方式来描述系统的某一部分我希望它处在一种什么状态, 如下面的例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">package</span> <span class="s2">&quot;vim&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">version</span> <span class="s2">&quot;1.16.1-1&quot;</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:install</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这条Resource就是描述说我希望我的系统中版本为1.16.1-1的vim这个包处于安装的状态,Resource会有一些属性(这里是version),对这个状态做自定.还会有一个动作,通过这个动作将系统的某一部分改变到我们希望的状态.</p>

<p>那么什么是Providers呢,看上面的例子,如果我们把它用bash命令来表示,它可能会是<code>yum -y install vim</code>或<code>apt-get install vim</code>.我们之所以可以用上面那种抽象的方式来表达我的需求,而不用关心底层它是怎么做到的,就是因为有Provider为我们做这个工作.Provider为我们提供了这一层的抽象</p>

<h2>文件位置</h2>

<p>轻量级(或叫自定义)Resources和Providers分区从cookbook的<code>resources</code>和<code>providers</code>目录加载.Resources和Providers的名字由cookbook的名字与文件的名字通过下画线组合而成.唯一的例外是文件名为<code>default.rb</code>.在这种情况下Resources和Providers的名字仅是cookbook的名字</p>

<h3>例子</h3>

<p>Note: 下面的例子只是为了说明名字,不一定真的有这些LWRP</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">+----------------------------------------------------------------------------------------+-------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="no">Filename</span>                               <span class="o">|</span> <span class="no">Resource</span> <span class="ow">or</span> <span class="no">Provider</span> <span class="no">Name</span><span class="p">,</span> <span class="n">as</span> <span class="n">used</span> <span class="k">in</span> <span class="n">the</span> <span class="no">DSL</span> <span class="o">|</span> <span class="no">Generated</span> <span class="no">Class</span>                     <span class="o">|</span>
</span><span class='line'><span class="o">+----------+-----------------------------+-----------------------------------------------+-------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="sr">/cookbooks/</span><span class="n">aws</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">rb</span>    <span class="o">|</span> <span class="n">aws</span>                                           <span class="o">|</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="o">::</span><span class="no">Aws</span>                 <span class="o">|</span>
</span><span class='line'><span class="o">+----------------------------------------+-----------------------------------------------+-------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="sr">/cookbooks/</span><span class="n">aws</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">elastic_ip</span><span class="o">.</span><span class="n">rb</span> <span class="o">|</span> <span class="n">aws_elastic_ip</span>                                <span class="o">|</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resourcesce</span><span class="o">::</span><span class="no">AwsElasticIp</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+----------------------------------------+-----------------------------------------------+-------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="sr">/cookbooks/</span><span class="n">aws</span><span class="o">/</span><span class="n">providers</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">rb</span>    <span class="o">|</span> <span class="n">aws</span>                                           <span class="o">|</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Providerser</span><span class="o">::</span><span class="no">Aws</span>              <span class="o">|</span>
</span><span class='line'><span class="o">+----------------------------------------+-----------------------------------------------+-------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="sr">/cookbooks/</span><span class="n">aws</span><span class="o">/</span><span class="n">providers</span><span class="o">/</span><span class="n">elastic_ip</span><span class="o">.</span><span class="n">rb</span> <span class="o">|</span> <span class="n">aws_elastic_ip</span>                                <span class="o">|</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Providerrovider</span><span class="o">::</span><span class="no">AwsElasticIp</span> <span class="o">|</span>
</span><span class='line'><span class="o">+----------------------------------------+-----------------------------------------------+-------------------------------------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>前面已经说过,Resources会有一个或多个属性,我们在写Recipe的时候会给属性一些我们想要的值,这些值可以通过属性传给Provider.Resources还会有一个动作,这个动作具体做什么是在Providers中定义的</p>

<h2>Providers</h2>

<p>Providers就是支持Resources的,它可以通过实例变量<code>@new_resource</code>做为载体来来得到我们在Recipes中传给Resources的属性在值,定义Resource中的动作具体做些什么动作.完了之后调用`@new_resource.updated_by_last_action(true)来告诉Chef我们做完了</p>

<p>下面我们以一个简单的例子来加深一下理解,主要注意里面变量(属性)的传递</p>

<h2>简单的例子</h2>

<p>这个例子我们简单的封装一个内容Resource类型<code>user</code>得到一个LWRP</p>

<p>首先我们利用knife命令创建cookbook的目录结构</p>

<pre><code>knife cookbook create users
</code></pre>

<p>然后我们直接在resources目录下创建我们的resource</p>

<figure class='code'><figcaption><span>vim users/resources/manage.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">actions</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:remove</span>
</span><span class='line'>
</span><span class='line'><span class="n">attribute</span> <span class="ss">:user_name</span><span class="p">,</span> <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们定义了两个动作和一个属性,这两个具体做什么工作是在Provider中实现的,在recipe使用这个Resource的时候传来属性的值可以在Provider中访问到</p>

<p>下面我们创建我们的Provider用来支持Resource.实现上就是定义前面的两个动作要做什么工作</p>

<figure class='code'><figcaption><span>vim users/providers/manage.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">action</span> <span class="ss">:remove</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">user_name</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">action</span> <span class="ss">:remove</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">action</span> <span class="ss">:create</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">user_name</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">action</span> <span class="ss">:create</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们定义了两个动作,使用内置的Resource类型<code>user</code>来创建用户,利用<code>new_resource</code>得到从recipes中传来的用户名,最后更新状态</p>

<p>下面我们就在这个cookbook中使用我们定义的Resource.Cookbook的名字为<code>users</code>,Resouces文件的名字为<code>manage.rb</code>,所以我们的Resource名字为<code>users_manage</code></p>

<figure class='code'><figcaption><span>vim users/recipes/test.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">users_maange</span> <span class="s2">&quot;william&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user_name</span> <span class="s2">&quot;william&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在就可以测试我们写的LWRP了</p>

<pre><code>knife cookbook upload users
knife node run list add client1.chef.com 'recipe[users::test]'
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/03/install-gitolite/">安装配置Git服务器Gitolite</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-03T18:38:00+08:00" pubdate data-updated="true">Oct 3<span>rd</span>, 2012</time>
        
         | <a href="/blog/2012/10/03/install-gitolite/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Gitolite的代码做了更改,网上好多安装教程都不再适用,所以在这里简单记录一下我的安装方法</p>

<h3>安装</h3>

<h4>首先安装必要的软件</h4>

<pre><code>yum -y install git
</code></pre>

<h4>添加用户</h4>

<pre><code>useradd --system --shell /bin/bash --create-home git
</code></pre>

<h4>设置密码</h4>

<pre><code>passwd git
</code></pre>

<h4>拷贝公钥</h4>

<p>Gitolite管理的方式是给你一个特殊的仓库,修改,提交,推送到服务器就可以了,这个仓库只可以管理员访问,现在把管理员的公钥复制到服务器上(可以和Git服务器在同一台服务器上也可以在不同的服务器上)</p>

<pre><code># 如果没有key先生成
ssh-keygen
ssh-copy-id git@git-server
</code></pre>

<h4>安装Gitolite</h4>

<p>现在在Git服务器上切换到git用户进行安装</p>

<pre><code># change to git user
su - git

# gitolite will install here
mkdir bin

# authorized_keys is admin's pubkey
mv ~/.ssh/authorized_keys ~/git.pub

# get the source code
git clone git://github.com/sitaramc/gitolite.git

# install
~/gitolite/install -to ~/bin

# setup
~/bin/gitolite setup -pk ~/git.pub
</code></pre>

<p>安装已经完成了,可以在以管理用户进行测试(前面运行<code>ssh-copy-id</code>的服务器)</p>

<pre><code>ssh git@chef-server
</code></pre>

<p>应该看到类似这样的输出:</p>

<pre><code>hello git, this is git@desktop running gitolite3 v3.04-20-g6328ec2 on git 1.7.9.5

  R W   gitolite-admin
Connection to localhost closed.closed
</code></pre>

<p>可以把管理仓库克隆下来管理Git服务器</p>

<pre><code>git clone git:git-server:gitolite-admin.git
</code></pre>

<p>要添加用户,只要把用户的公钥复制到这个仓库里的<code>keydir</code>下并以<code>username.pub</code>命名,然后提交并推送到服务器</p>

<h3>添加用户示例(jenny)</h3>

<pre><code>cd gitolite-admin
cp path/of/jenny's/pubkey keydir/jenny.pub
git add keydir
git commit -m "add new user jenny"
git push
</code></pre>

<h3>创建仓库示例</h3>

<p>假如我们要创建一个名为<code>notes</code>的仓库,让刚创建的<code>jenny</code>有读写权限</p>

<pre><code>cd gitolite-admin
vi conf/gitolite.conf
</code></pre>

<p>添加类似下面这内容进去</p>

<pre><code>repo notes
    RW    =   jenny
</code></pre>

<p>保存,提交并推送到远和服务</p>

<pre><code>git add -u
git commit -m 'add new repo notes and assign RW to jenny'
git push
</code></pre>

<p>推送的时候应该看到类似这样的信息</p>

<pre><code>Counting objects: 7, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (4/4), 395 bytes, done.
Total 4 (delta 1), reused 0 (delta 0)
remote: Initialized empty Git repository in /home/git/repositories/notes.git/
To git@desktop:gitolite-admin
   6de90b8..52737aa  master -&gt; master
</code></pre>

<p>注意<code>remote</code>开头的一行,它已经帮你创建了这个仓库</p>

<h3>通配符仓库的创建示例</h3>

<p>通配符仓库事先不能确定名字,所以不会帮你创建,在你clone的时候才会创建</p>

<p>编辑<code>conf/gitolite.conf</code>文件在里面加入类似下面的内容</p>

<pre><code>repo sandbox/.+$
  C      =   jenny
  RW+C   =   jenny
</code></pre>

<p>注意<code>C  =  username</code>的一行必不可少,这里的<code>C</code>是指创建仓库的意思,下一行的<code>RW+C</code>中的<code>C</code>是指创建引用(branch,tag)的意思</p>

<p>保存后提交并推送到服务上去</p>

<pre><code>git add -u
git commit -m 'add wildcard repo'
git push
</code></pre>

<p>注意看<code>push</code>时输出的信息,应该没有创建仓库的信息</p>

<p>这时<code>jenny</code>克隆仓库的时候会自动创建</p>

<pre><code># as jenny user
git clone git@desktop:sandbox/test.git
</code></pre>

<p>输出应该类似这样</p>

<pre><code>Cloning into 'test'...
Initialized empty Git repository in /home/git/repositories/sandbox/test.git/
warning: You appear to have cloned an empty repository.
</code></pre>

<p>如果你的输出报这样的错</p>

<pre><code>FATAL: R any sandbox/test jenny DENIED by fallthru
(or you mis-spelled the reponame)
fatal: The remote end hung up unexpectedly
</code></pre>

<p>一般是没有<code>C  =  username</code>这一行,注意是只有<code>C</code>的一行</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/27/actionbarsherlock-setup/">ActionBarSherlock使用</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/13/understand-stub-and-mock/">理解测试中的stub和mock</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/23/opensuse-12-dot-3-font-configuration/">openSUSE 12.3 安装完后需要做的事情</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/05/rvm-rake-cron-ubuntu/">最简单的在crontab中执行rake命令的方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/25/rails-image-upload/">Rails图片上传</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/12/proxy-chef-server-with-nginx/">使用Nginx+SSL代理chef-server</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/10/chef-attributes/">Chef基础之Arrtibutes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/10/learning-git-resources/">Git学习资料收集</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/williamherry">@williamherry</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'williamherry',
            count: 6,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - William Herry -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'williamherry';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
