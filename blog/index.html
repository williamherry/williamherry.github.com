
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>William's Blog with Octopress</title>
  <meta name="author" content="William Herry">
  <meta name="google-site-verification" content="_KlSpzhIase_SfpNrkXR9D4RIMUinnyi_QB6FS7UhBs" />

  
  <meta name="description" content="这篇博客的目的是研究一下从git push到commit出现在gitlab页面上中间发生到什么 开始之前补充一点背景知识，ssh可以执行命令， Gitlab以及Gitolite这些操作远程仓库应该都有用这个技术 比如我们可以在~/.ssh/authorized_keys中加上自己当command &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://williamherry.com/blog/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="William's Blog with Octopress" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


<!-- this font looks great -->
<link href='http://fonts.googleapis.com/css?family=Delius' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">William's Blog with Octopress</a></h1>
  
    <h2>Octopress is A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:williamherry.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/19/from-git-push-to-commit-show-on-page/">Gitlab Shell如何工作</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-19T11:55:00+08:00" pubdate data-updated="true">Jul 19<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/07/19/from-git-push-to-commit-show-on-page/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这篇博客的目的是研究一下从<code>git push</code>到commit出现在gitlab页面上中间发生到什么</p>

<p>开始之前补充一点背景知识，<a href="http://cybermashup.com/2013/05/14/restrict-ssh-logins-to-a-single-command/">ssh可以执行命令</a>， Gitlab以及Gitolite这些操作远程仓库应该都有用这个技术</p>

<p>比如我们可以在<code>~/.ssh/authorized_keys</code>中加上自己当command</p>

<pre><code>command="./cmd" ssh-rsa &lt;my-rsa-key&gt;
</code></pre>

<p>这样就没法用ssh登陆了，每次登陆只会执行cmd这个程序</p>

<p>就像上面文章里写的，我们还可以用<code>$SSH_ORIGINAL_COMMAND</code>变量取到客户端发来当命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>echo $SSH_ORIGINAL_COMMAND</span></code></pre></td></tr></table></div></figure>


<pre><code>chmod +x ~/cmd
</code></pre>

<p>现在如果在登陆的时候后面参数，就可以回显里</p>

<pre><code>$ ssh git@gitlab.williamherry.com a b c
# =&gt; a b c
</code></pre>

<p>Gitlab-shell就用的这个技术，<code>~/.ssh/authorized_keys</code>加一条类似这样当纪录</p>

<pre><code>command="/home/git/gitlab-development-kit/gitlab-shell/bin/gitlab-shell key-15",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa &lt;my-rsa-key&gt;
</code></pre>

<p>看一下gitlab-shell的代码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env ruby
</span><span class='line'>
</span><span class='line'>unless ENV['SSH_CONNECTION']
</span><span class='line'>  puts "Only ssh allowed"
</span><span class='line'>  exit
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>key_id = /key-[0-9]+/.match(ARGV.join).to_s
</span><span class='line'>original_cmd = ENV['SSH_ORIGINAL_COMMAND']
</span><span class='line'>
</span><span class='line'>require_relative '../lib/gitlab_init'
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'>#
</span><span class='line'># GitLab shell, invoked from ~/.ssh/authorized_keys
</span><span class='line'>#
</span><span class='line'>#
</span><span class='line'>require File.join(ROOT_PATH, 'lib', 'gitlab_shell')
</span><span class='line'>
</span><span class='line'>if GitlabShell.new(key_id, original_cmd).exec
</span><span class='line'>  exit 0
</span><span class='line'>else
</span><span class='line'>  exit 1
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>它从ARGV读到key_id，从环境变量<code>SSH_ORIGINAL_COMMAND</code>读到命令, 我们把它写到文件看看git push对应的命令是什么，在文件中加入下面一行代码</p>

<pre><code>File.write('/tmp/sss', ENV['SSH_ORIGINAL_COMMAND'])
</code></pre>

<p>通过测试发现有下面的对应关系</p>

<pre><code>git push  =&gt; git-receive-pack &lt;repo&gt;
git pull  =&gt; git-upload-pack &lt;repo&gt;
git fetch =&gt; git-upload-pack &lt;repo&gt;
</code></pre>

<p>现在key的id有了，命令有了，操作的repo也有了，我们看一下gitlab-shell怎么处理</p>

<pre><code>GitlabShell.new(key_id, original_cmd).exec
</code></pre>

<p>他用参数创建了一个GitlabShell实例之后执行exec方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">key_id</span><span class="p">,</span> <span class="n">origin_cmd</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@key_id</span> <span class="o">=</span> <span class="n">key_id</span>
</span><span class='line'>  <span class="vi">@origin_cmd</span> <span class="o">=</span> <span class="n">origin_cmd</span>
</span><span class='line'>  <span class="vi">@config</span> <span class="o">=</span> <span class="no">GitlabConfig</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="vi">@repos_path</span> <span class="o">=</span> <span class="vi">@config</span><span class="o">.</span><span class="n">repos_path</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>初始化只是把一些变量保存到了实例变量中，我们重点追踪cmd，记住这里到origin_cmd是&#8217;git-receive-pack <repo>&lsquo;（我们只追踪git push）</p>

<p>然后就是执行exec方法，该方法主要执行三个步骤</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">exec</span>
</span><span class='line'>  <span class="n">parse_cmd</span>
</span><span class='line'>  <span class="n">verify_access</span>
</span><span class='line'>  <span class="n">process_cmd</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>parse_cmd解析了一个origin_cmd，把命令（git-receive-pack）赋给了实例变量@git_cmd和@git_access，把repo赋给了实例变量@repo_name</p>

<p>verify_access拿前面得到的数据调用gitlab的api去验证看合不合法</p>

<p>最后process_cmd调用exec_cmd然后再调用了这样一行代码</p>

<pre><code>Kernel::exec({ 'PATH' =&gt; ENV['PATH'], 'LD_LIBRARY_PATH' =&gt; ENV['LD_LIBRARY_PATH'], 'GL_ID' =&gt; @key_id }, *args, unsetenv_others: true)
</code></pre>

<p>把变量都替换成真实的数据得到</p>

<pre><code>Kernel::exec({ 'path' =&gt; /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games, 'LD_LIBRARY_PATH' =&gt; , 'GL_ID' =&gt; key-15}, ["git-receive-pack", "/home/git/gitlab-development-kit/repositories/williamherry/test2.git"], unsetenv_others: true })
</code></pre>

<p>这里更深入的分析再以后再搞，简单说就是git push的时候gitlab-shell再服务端打开一个接受历程等待接收pack，客户端发送pack，好像从这里就断掉了，前面说的要在gitlab网站中现实的数据是在什么什么创建的呢？</p>

<p>你猜对了，他就是利用对git的<a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">hooks</a>，查看gitlab-shell目录下的hooks目录会发现有三个hooks， <code>post-receive  pre-receive  update</code>，push应该对应的是post-receive, 再里面添加打印信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This file was placed here by GitLab. It makes sure that your pushed commits</span>
</span><span class='line'><span class="c1"># will be processed properly.</span>
</span><span class='line'>
</span><span class='line'><span class="n">refs</span> <span class="o">=</span> <span class="no">ARGF</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'><span class="n">key_id</span>  <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GL_ID&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">repo_path</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">refs</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">key_id</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">repo_path</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># reset GL_ID env since we already got its value</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GL_ID&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/gitlab_custom_hook&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../lib/gitlab_post_receive&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="no">GitlabPostReceive</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">refs</span><span class="p">)</span><span class="o">.</span><span class="n">exec</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>    <span class="no">GitlabCustomHook</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">post_receive</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>push的输出中包含了相关的信息，这里的hooks是成功后才执行的，如果你没有新commit，push就不会有这些输出</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">remote</span><span class="p">:</span> <span class="ss">refs</span><span class="p">:</span> <span class="mi">8939</span><span class="n">f77074dc85ac4529fcec1245f7c4563e17cd</span> <span class="n">a6cd629e9deefb0ab9638217bdd82ae68ff17099</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
</span><span class='line'><span class="ss">remote</span><span class="p">:</span> <span class="n">key_id</span><span class="p">:</span> <span class="n">key</span><span class="o">-</span><span class="mi">15</span>
</span><span class='line'><span class="ss">remote</span><span class="p">:</span> <span class="n">repo_path</span><span class="p">:</span> <span class="sr">/home/</span><span class="n">git</span><span class="o">/</span><span class="n">gitlab</span><span class="o">-</span><span class="n">development</span><span class="o">-</span><span class="n">kit</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">williamherry</span><span class="o">/</span><span class="n">test2</span><span class="o">.</span><span class="n">git</span>
</span></code></pre></td></tr></table></div></figure>


<p>再这个hooks中它执行了GitlabPostReceive的exec方法和GitlabCustomHook的post_receive方法。而后面这个只是负责去执行custom_hooks下面的hooks，所以我们只看一看前面一个</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GitlabPostReceive</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">changes</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@config</span> <span class="o">=</span> <span class="no">GitlabConfig</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@repo_path</span><span class="p">,</span> <span class="vi">@actor</span> <span class="o">=</span> <span class="n">repo_path</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">actor</span>
</span><span class='line'>    <span class="vi">@changes</span> <span class="o">=</span> <span class="n">changes</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">exec</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">update_redis</span>
</span><span class='line'>    <span class="n">broadcast_message</span> <span class="o">=</span> <span class="no">GitlabNet</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">broadcast_message</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update_redis</span>
</span><span class='line'>    <span class="nb">system</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="o">.</span><span class="n">redis_command</span><span class="p">,</span> <span class="s1">&#39;rpush&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="ss">err</span><span class="p">:</span> <span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="ss">out</span><span class="p">:</span> <span class="s1">&#39;/dev/null&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我把代码做了简化，去掉了不重要的步骤，简单说这个hooks做了两件是：往redis里塞里一条数据，查了下广播（不知道是干什么的，不过好像不是很重要的样子），用puts发现它是往队列<code>resque:gitlab:queue:post_receive</code>中添加里这样一条信息</p>

<pre><code>  {"class":"PostReceive","args":["/home/git/gitlab-development-kit/repositories/williamherry/test2.git","key-15","YTZjZDYyOWU5ZGVlZmIwYWI5NjM4MjE3YmRkODJhZTY4ZmYxNzA5OSA1MjJj\nZDhhN2MwMDEzYWU0MGU3ZTVhZDFiM2I5ZjlhNGE2OWYzNmIyIHJlZnMvaGVh\nZHMvbWFzdGVyCg==\n"]}
</code></pre>

<p>那一串奇怪的字符是Base64加密后的@changes，而@changes就是前面的refs即：</p>

<pre><code>8939f77074dc85ac4529fcec1245f7c4563e17cd a6cd629e9deefb0ab9638217bdd82ae68ff17099 refs/heads/master
</code></pre>

<p>好了，现在我们知道gitlab-shell和gitlag是通过redis共享数据的，接下来就是gitlab的<code>app/workers/post_receive.rb</code>中的代码做相应的处理了</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/17/meta-ruby-note/">Ruby元编程读书笔记</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-17T14:18:00+08:00" pubdate data-updated="true">Jul 17<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/07/17/meta-ruby-note/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>由于C语言绝大多数编译时的信息在运行时都丢失了，所以C语言不支持元编程或內省</p></blockquote>

<p>实例方法：在类中定义，在实例中使用</p>

<p>Ruby的class关键词更像一个作用域操作符而不是类型声明语句</p>

<p>一个对象仅仅包含它的实例变量以及一个对自身类的引用</p>

<p>方法存放在类中而不是实例中</p>

<p>类自身也是对象，作为对象它的类事Class</p>

<p>超类是指类之间的继承关系</p>

<p>任何以大写字母开头的引用（包括类名和模块名），都是常亮</p>

<p>方法查找：如果不引入eigenclass, 方法查找被称为“向右一步，在向上”， 也就是说，先向右一步来到接受者所在的类中查找，然后沿着祖先链向上直到找到给定的方法。如果有eigenclass，那么最先会在接收者的eigenclass中查找</p>

<p>默认类是从Object类继承而来，即</p>

<pre><code>class MyClass
end
</code></pre>

<p>和</p>

<pre><code>class MyClass &lt; Object
end
</code></pre>

<p>一样</p>

<p>类和模块的定义中（并且在任何方法之外），self的角色由这个类或模块担任</p>

<p>私有方法服从一个简单的规则：不能明确指定一个接收者调用一个私有方法</p>

<pre><code>class A
  include B
end
</code></pre>

<p>include会把被引入模块B插入到引入模块A祖先链中该模块A的上方</p>

<pre><code>A.ancestors # =&gt; [A, B, Object, Kernel, BasicObject]
</code></pre>

<p>没有明确指定接收者的调用都会作用于self</p>

<p>当调用一个方法时，实际上是给一个对象发送了一条消息</p>

<p>符号和字符串没有关系，并且它们属于完全不同的类</p>

<p>符号是不可变的</p>

<p>一些操作（比如比较操作）针对符号运行的更快</p>

<p>动态调用方法就动态派发</p>

<p>动态定义方法叫动态方法</p>

<p>method_missing叫幽灵方法</p>

<p>什么事拟态方法？</p>

<p>什么事类宏？</p>

<p>只有在调用一个方法事才可以定义一个块，yield回调这个块，Kernel＃block_given?()方法判断是否包含块</p>

<p>什么事闭包？</p>

<p>当定义一个块时，它会获取当时环境中的绑定，并且把它传给一个方法时，它会带着这些绑定一起进入该方法</p>

<p>块会覆盖具有相同名字的局部变量</p>

<p>类和模块定义中的代码会被立即执行，相反，方法定义中的代码只有在方法被调用的时被执行</p>

<p>&amp;操作符的真正含义：这是一个Proc对象，我想把它当成一个块在使用</p>

<p>可调用对象可以有一下方式：</p>

<ul>
<li>块（虽然它们不是真正的对象，但是它们是可调用的）：在定义它们的作用域中执行</li>
<li>proc：Proc类的对象，跟块一样，它们在定义自身的作用域中执行</li>
<li>lambda：也是Proc类的对象，但是它跟普通的proc有细微的区别。它跟块和proc一样都是闭包，因此可以在定义自身的作用域中执行</li>
<li>方法：绑定于对象，在所绑定对象的作用域中执行</li>
</ul>


<p>可调用对象的区别：</p>

<ul>
<li>在方法和lambda中，return语句从可调用对象中返回</li>
<li>在块和proc中，return语句从定义可调用对象的原始上下文中返回</li>
<li>对传入参数的处理：方法最严格，lambda同样严格（它与方法相比，在某些极端情况下略为宽松），而proc和块则要宽松一些</li>
</ul>


<p>类方法就是类的单件方法，它存在于该类的eigenclass中</p>

<p>eigenclass的超类就是超类的eigenclass（有什么用）</p>

<p><code>class &lt;&lt; obj</code> 进入对象的eigenclass</p>

<p>当类包含模块时，它获得的是该模块的实例方法－－而不是类方法。类方法存在于模块的eigenclass中</p>

<p>如果在对象的eigenclass中包含模块，就可以把该模块的实例方法导入到该对象的eigenclass中，从而成为该对象自己的方法</p>

<p>Object#extend只是在接收者eigenclass中包含模块的快捷方式</p>

<p>关于别名：</p>

<p>可以把方法看成有名字（name）和方法内容（body）两部分组成，名字指向方法内容</p>

<pre><code>def m1
  # body
end
</code></pre>

<p>经过</p>

<pre><code>alias m2 m1
</code></pre>

<p>后，m2也指向类m1的方法内容b1
这时候在重定义m1</p>

<pre><code>def m1
  # body 2
end
</code></pre>

<p>m1就会指向b2，原来的方法内容只能通过m2来引用了</p>

<p>注意alias是一个关键字，后面两个参数中间没有逗号</p>

<p>环绕别名：先定义别名，在重定义方法，在其中使用别名</p>

<pre><code>alias new_name old_name
</code></pre>

<p>class是保留词，除了使用klass替代外还可以用clazz</p>

<p>类扩展混入：</p>

<pre><code>module MyMixin
  def self.included(base)
    base.extend(ClassMethods)
  end

  module ClassMethods
    def x
      "x()"
    end
  end
end
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/22/build-rails-dev-env-using-docker/">使用Docker搭建一个Rails开发环境</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-22T14:56:00+08:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2015</time>
        
         | <a href="/blog/2015/01/22/build-rails-dev-env-using-docker/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>如果使用的fig的话那就太简单了,照着fig官方文档分分钟就可以搞定,但是它的方法存在一个问题,他是直接用的ruby,postgres,redis的image,整个加起来就上G了,国内的这破网速,虽然只需下载一次就好了,并且国内也有镜像加速的服务如daocloud,但实际使用发现任然无法接受.所以我的方法是使用一个基本的ubuntu镜像,其他镜像在此基础上构建而成</p>

<p>首先是多官方的ubuntu镜像做稍微修改,这个修改就是把源换成网易的,然后制作成一个镜像,其他的镜像都一次为基础</p>

<p>想看一下相关的文件:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># tree .
</span><span class='line'>├── Dockerfile
</span><span class='line'>├── docker
</span><span class='line'>│   ├── gemrc
</span><span class='line'>│   ├── postgres
</span><span class='line'>│   │   ├── Dockerfile
</span><span class='line'>│   │   ├── pg_hba.conf
</span><span class='line'>│   │   ├── postgresql.conf
</span><span class='line'>│   │   └── run
</span><span class='line'>│   └── redis
</span><span class='line'>│       ├── Dockerfile
</span><span class='line'>│       └── redis.conf
</span><span class='line'>└── fig.yml</span></code></pre></td></tr></table></div></figure>


<p>我们使用fig来编排,所以fig.yml就是主要的入口了,内容如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>db:
</span><span class='line'>  build: ./docker/postgres
</span><span class='line'>redis:
</span><span class='line'>  build: ./docker/redis
</span><span class='line'>web:
</span><span class='line'>  build: .
</span><span class='line'>  command: bundle exec rails s -b 0.0.0.0 -p 3000
</span><span class='line'>  volumes:
</span><span class='line'>    - .:/myapp
</span><span class='line'>  ports:
</span><span class='line'>    - "3000:3000"
</span><span class='line'>  links:
</span><span class='line'>    - db
</span><span class='line'>    - redis</span></code></pre></td></tr></table></div></figure>


<p>这里有三个部分,前面两个都是知道从什么地方找Dockerfile来build镜像(fig官方的例子这里是用的image: postgres)</p>

<p>第三个就是实际跑rails的image了,它指定了一个image启动后运行的命令(其他两个镜像也有启动后要执行的命令,是在Dockerfile里指定),然后有一个volumes把代码目录镜像到images是,这样修改了代码不用做操作就可以看到效果</p>

<p>ports指令把image里的端口映射到宿主机上,宿主机并不一定就是我们的开发机,像Mac使用boot2docker安装的docker,那么开发机就是运行docker的虚拟机了,可以用boot2docker ip得到ip地址,等之后配置完成了就可以用这个地址加3000端口查看网页了</p>

<p>最后的links会在web的image执行的时候(就是container)在其的/etc/hosts里加一条到其他container地址的对应,要知道每个container运行IP都是不一样的,这样就可以在web去连db和redis了,相应的database.yml里把host写成db就可以了</p>

<p>我们一个一个来看他们是怎么build的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat docker/postgres/Dockerfile
</span><span class='line'>FROM williamherry/ubuntu
</span><span class='line'>MAINTAINER William Herry &lt;WilliamHerryChina@Gmail.com&gt;
</span><span class='line'>ENV DOCKERFILE_VERSION 0.0.1.1
</span><span class='line'>
</span><span class='line'>RUN locale-gen en_US.UTF-8
</span><span class='line'>RUN update-locale LANG=en_US.UTF-8
</span><span class='line'>
</span><span class='line'>RUN apt-get -qqy update && DEBIAN_FRONTEND=noninteractive apt-get install -qqy postgresql-9.3 postgresql-contrib-9.3 postgresql-9.3-postgis-2.1 libpq-dev sudo
</span><span class='line'>
</span><span class='line'># /etc/ssl/private can't be accessed from within container for some reason
</span><span class='line'># (@andrewgodwin says it's something AUFS related)
</span><span class='line'>RUN mkdir /etc/ssl/private-copy; mv /etc/ssl/private/* /etc/ssl/private-copy/; rm -r /etc/ssl/private; mv /etc/ssl/private-copy /etc/ssl/private; chmod -R 0700 /etc/ssl/private; chown -R postgres /etc/ssl/private
</span><span class='line'>
</span><span class='line'>ADD postgresql.conf /etc/postgresql/9.3/main/postgresql.conf
</span><span class='line'>ADD pg_hba.conf /etc/postgresql/9.3/main/pg_hba.conf
</span><span class='line'>RUN chown postgres:postgres /etc/postgresql/9.3/main/*.conf
</span><span class='line'>
</span><span class='line'>ADD main /var/lib/postgresql/9.3/main
</span><span class='line'>RUN chown -R postgres:postgres /var/lib/postgresql/9.3/main
</span><span class='line'>
</span><span class='line'>ADD run /usr/local/bin/run
</span><span class='line'>RUN chmod +x /usr/local/bin/run
</span><span class='line'>
</span><span class='line'>EXPOSE 5432
</span><span class='line'>CMD ["/usr/local/bin/run"]</span></code></pre></td></tr></table></div></figure>


<p>这个是直接抄的<a href="https://github.com/orchardup/docker-postgresql,">https://github.com/orchardup/docker-postgresql,</a> 刚发现他github项目主页就是这个已经是Deprecated,请使用官方镜像</p>

<p>简单说就是安装postgresql,把配置文件改改,让访问权限宽松一点,在启动起来</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ADD main /var/lib/postgresql/9.3/main
</span><span class='line'>RUN chown -R postgres:postgres /var/lib/postgresql/9.3/main</span></code></pre></td></tr></table></div></figure>


<p>上面这两行是我添加的,实现把一些初始数据导入,把postgresql数据目录的文件整个放在<code>docker/postgres/main</code>下面build镜像,就可以一启动就有seed数据了</p>

<p>下面看看redis的Dockerfile</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat docker/redis/Dockerfile
</span><span class='line'>FROM williamherry/ubuntu
</span><span class='line'>MAINTAINER William Herry &lt;WilliamHerryChina@Gmail.com&gt;
</span><span class='line'>ENV DOCKERFILE_VERSION 0.0.1
</span><span class='line'>
</span><span class='line'>RUN apt-get update -qqy && apt-get install -qqy redis-server
</span><span class='line'>
</span><span class='line'>ADD redis.conf /etc/redis/redis.conf
</span><span class='line'>CMD ["redis-server", "/etc/redis/redis.conf"]
</span><span class='line'>
</span><span class='line'>EXPOSE 6379</span></code></pre></td></tr></table></div></figure>


<p>这个就更简单了,安装,加个配置文件,启动</p>

<p>配置文件主要修改了两个地方:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>daemonize no
</span><span class='line'>bind 0.0.0.0</span></code></pre></td></tr></table></div></figure>


<p>似乎docker在后台运行是不行的</p>

<p>最后我们看看web的Dockerfile</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat Dockerfile
</span><span class='line'>FROM williamherry/ubuntu
</span><span class='line'>MAINTAINER William Herry &lt;WilliamHerryChina@Gmail.com&gt;
</span><span class='line'>ENV DOCKERFILE_VERSION 0.0.1
</span><span class='line'>
</span><span class='line'>ENV RUBY_MAJOR 2.1
</span><span class='line'>ENV RUBY_VERSION 2.1.5
</span><span class='line'>ENV RUBY_SRC_DIR /usr/src/ruby
</span><span class='line'>
</span><span class='line'># Essentials
</span><span class='line'>RUN apt-get update -qqy \
</span><span class='line'>  && apt-get install -qqy \
</span><span class='line'>    autoconf \
</span><span class='line'>    build-essential \
</span><span class='line'>    curl \
</span><span class='line'>    git \
</span><span class='line'>    imagemagick \
</span><span class='line'>    libbz2-dev \
</span><span class='line'>    libcurl4-openssl-dev \
</span><span class='line'>    libevent-dev \
</span><span class='line'>    libffi-dev \
</span><span class='line'>    libglib2.0-dev \
</span><span class='line'>    libjpeg-dev \
</span><span class='line'>    libmagickcore-dev \
</span><span class='line'>    libmagickwand-dev \
</span><span class='line'>    libmysqlclient-dev \
</span><span class='line'>    libncurses-dev \
</span><span class='line'>    libpq-dev \
</span><span class='line'>    libreadline-dev \
</span><span class='line'>    libsqlite3-dev \
</span><span class='line'>    libssl-dev \
</span><span class='line'>    libxml2-dev \
</span><span class='line'>    libxslt-dev \
</span><span class='line'>    libyaml-dev \
</span><span class='line'>    procps \
</span><span class='line'>    zlib1g-dev \
</span><span class='line'>  && rm -rf /var/lib/apt/lists/*
</span><span class='line'>
</span><span class='line'>RUN apt-get update -qqy \
</span><span class='line'>  && apt-get install -qqy locales \
</span><span class='line'>  && rm -rf /var/lib/apt/lists/* \
</span><span class='line'>  && localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
</span><span class='line'>ENV LANG en_US.utf8
</span><span class='line'>
</span><span class='line'># Ruby specifics
</span><span class='line'>RUN apt-get update -qqy \
</span><span class='line'>  && apt-get install -qqy \
</span><span class='line'>    bison \
</span><span class='line'>    ruby \
</span><span class='line'>  && rm -rf /var/lib/apt/lists/* \
</span><span class='line'>  && mkdir -p $RUBY_SRC_DIR \
</span><span class='line'>  && curl -s -SL "http://ruby.taobao.org/mirrors/ruby/2.1/ruby-$RUBY_VERSION.tar.bz2" \
</span><span class='line'>    | tar -xjC $RUBY_SRC_DIR --strip-components=1
</span><span class='line'>
</span><span class='line'>WORKDIR $RUBY_SRC_DIR
</span><span class='line'>
</span><span class='line'>RUN autoconf \
</span><span class='line'>  && ./configure \
</span><span class='line'>    --disable-install-doc \
</span><span class='line'>  && make -j"$(nproc)" \
</span><span class='line'>  && apt-get purge -qqy --auto-remove bison ruby \
</span><span class='line'>  && make install \
</span><span class='line'>  && rm -r /usr/src/ruby
</span><span class='line'>
</span><span class='line'>RUN mkdir /myapp
</span><span class='line'>WORKDIR /myapp
</span><span class='line'>ADD . /myapp
</span><span class='line'>ADD config/database.yml.fig /myapp/config/database.yml
</span><span class='line'>ADD config/secrets.yml.fig /myapp/config/secrets.yml
</span><span class='line'>ADD docker/gemrc /root/.gemrc
</span><span class='line'>RUN gem install bundler
</span><span class='line'>RUN bundle install</span></code></pre></td></tr></table></div></figure>


<p>前面那部分是网上找的安装ruby的配制方法,你可能不能理解为什么要自己安装ruby,你可以直接用官方ruby镜像,只要把FROM后面改成ruby就可以了,就是比较大而已,我发现下载安装好ruby的镜像还没从ubuntu镜像安装来的快</p>

<p>设置好之后就可以用下面的命令启动开发环境了(如果有数据放docker/postgres/main下,fig up就够了)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fig up -d db
</span><span class='line'>fig run web rake db:setup
</span><span class='line'>fig up</span></code></pre></td></tr></table></div></figure>


<p>从mkdir开始才是正在起作用的,太简单就不用说了,这里的.gemrc里知道了taobao的源,这样安装bundler就会快一点</p>

<p>最后说说踩过的一个坑,你可能注意到了每一个Dockerfile前面都有<code>ENV DOCKERFILE_VERSION 0.0.1</code>这一行,刚开始是<code>ENV VERSION 0.0.1</code>,这样会有一个问题,就是在执行migration的时候干脆不跑了,花了我一天的时间debug,最后发现他会把这个变量传进去,<code>rake db:migrate</code>就相当于<code>rake db:migrate VERSION=0.0.1</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/14/how-docker-image-works-with-aufs/">理解Docker镜像的存储原理</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-14T15:09:00+08:00" pubdate data-updated="true">Jan 14<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/01/14/how-docker-image-works-with-aufs/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>一开始接触Docker就对他镜像的存储原理很感兴趣,有一个问题一直不明白,Commit一个镜像的时候到底把什么存下来了,只知道他是使用分层的AUFS,具体不是特别很清楚,直到看了这篇关于<a href="http://www.thegeekstuff.com/2013/05/linux-aufs/">Linux AuFS的文章</a>,才有一个自己的认识,对不对还不知道</p>

<p>如果你用过Photoshop,那么用类比的方法就很好理解了,PS里作图一般都是一层一层的,上层如果没有内容就会透过去显示下层的内容,如果有旧覆盖下层内容.假设从下到上有ABC三层,A层上有一个红点,B层上靠右的地方有一个绿点(没有和A层上的重叠),如果只有这两层,那我们看到的就是一个红点加几个绿点,现在在上面有加一层C,他上面有一个蓝点和A层上红点的位置重叠,那么他就会覆盖A层的红点,最后我们看到的就是一个蓝点一个绿点</p>

<p>类比到文件也是这样,假设一个目录<code>/XXX</code>由自底向上的ABC三层组成,他们每一层都有一个和他们名字对应的文件(A=>A.txt, ..),同时他们都有一个叫<code>common.txt</code>文件,里面的内容分别是A,B,C,那么最终的结果是<code>/XXX</code>目录共有4个文件,<code>A.txt</code>, <code>B.txt</code>, <code>C.txt</code>和<code>common.txt</code>,而<code>common.txt</code>里的内容是C(最上层覆盖下层的)</p>

<p>我们可以用一个例子看看:</p>

<p>首先创建三个目录:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p /tmp/aufs/root
</span><span class='line'>mkdir -p /tmp/aufs/layer1
</span><span class='line'>mkdir -p /tmp/aufs/layer2</span></code></pre></td></tr></table></div></figure>


<p>创建相应的文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 'root' &gt; /tmp/aufs/root/root.txt
</span><span class='line'>echo 'layer1' &gt; /tmp/aufs/layer1/layer1.txt
</span><span class='line'>echo 'layer2' &gt; /tmp/aufs/layer2/layer2.txt
</span><span class='line'>
</span><span class='line'>echo 'root' &gt; /tmp/aufs/root/common.txt
</span><span class='line'>echo 'layer1' &gt; /tmp/aufs/root/common.txt
</span><span class='line'>echo 'layer2' &gt; /tmp/aufs/root/common.txt</span></code></pre></td></tr></table></div></figure>


<p>然后我们把他们按顺序Mount起来</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mount -t aufs -o br=/tmp/aufs/layer2:/tmp/aufs/layer1:/tmp/aufs/root none /tmp/aufs/root</span></code></pre></td></tr></table></div></figure>


<p>br后面的参数顺序是越后面越底层</p>

<p>现在<code>/tmp/aufs/root/</code>下应该有4个文件,<code>root.txt</code>, <code>layer1.txt</code>, <code>layer2.txt</code>和<code>common.txt</code>,并且<code>common.txt</code>里面的内容应该是<code>layer2</code>.同时由于现在layer2是最上层,那么<code>/tmp/aufs/root</code>里面做修改会反映到<code>/tmp/aufs/layer2</code>,在<code>/tmp/aufs/root</code>里创建文件,<code>/tmp/aufs/layer2</code>里也会出现</p>

<p>再回到前面的问题,Commit的时候到底保存的是什么呢,假设我们要基于前面的三层做修改在提交,只要再在上面加一层layer3,然后对<code>/tmp/aufs/root</code>做修改</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p /tmp/aufs/layer3
</span><span class='line'>umount /tmp/aufs/root
</span><span class='line'>mount -t aufs -o br=/tmp/aufs/layer3:/tmp/aufs/layer2:/tmp/aufs/layer1:/tmp/aufs/root none /tmp/aufs/root</span></code></pre></td></tr></table></div></figure>


<p>Note: 没有找到可以一层一层加的方法,只能先umount在按顺序mount</p>

<p>然后再<code>/tmp/aufs/root</code>下做修改</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 'layer3' &gt; /tmp/aufs/root/layer3.txt
</span><span class='line'>echo 'layer3' &gt; /tmp/aufs/root/common.txt</span></code></pre></td></tr></table></div></figure>


<p>这时候看<code>/tmp/aufs/layer3</code>目录,应该看到会有这两个文件,我们就可以把这个目录打个包实现Commit的目的</p>

<p>把这样的每一层保存下来,并想办法记录他们之间的关系(某一层的上层和下层是谁),差不多就可以实现Docker的镜像存储了,不过不一定对,具体怎么做得看了代码才知道</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/07/2014-conclusion-and-2015-plan/">2014年总结 && 2015年展望</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-07T10:30:00+08:00" pubdate data-updated="true">Jan 7<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/01/07/2014-conclusion-and-2015-plan/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2014年已经结束一周了,回顾过去这一年,同样又是收获颇多,很多方面都在持续地,稳定地,慢慢的提升,或许这就是幸福吧</p>

<h2>2014年总结</h2>

<h3>骑行</h3>

<p>骑行真是远远的超出了预期: 买了自行车,半年骑了差不多2000KM,参加了环萧山的比赛,完成了龙井十上十下的挑战.还记得第一次骑的时候就把一个电瓶车撞翻了,回来的时候领我骑的同事还摔了车,本以为这糟糕的开始会阻止我骑车的决心,结果出奇意外的之后都比较顺利,摔过几次车,都没什么大碍.希望2015年也可以平平安安的,并可以完成川藏线的挑战</p>

<h3>工作</h3>

<p>前面一直贪多求快,写了好多极低质量的代码,好多地方没有完全搞清楚,只是实现了基本的效果,就不去管了,导致后来出现各种诡异的,低级的Bug,有一段时间各种被同事吐槽,很不好过(不过我挺过去了,而且心里素质得到进一步提高,所以凡事都要辩证的区看). 所以之后一定要对自己的要求提高,争取做一个有追求的程序员</p>

<p>另外发现还是有好多技术理解的不够深刻,这可能都是习惯造成的,习惯上不喜欢去深究底层的东西,只有实现效果就不管了,这习惯一定得改,讲到习惯的地方在细谈</p>

<h3>五笔 => 拼音</h3>

<p>由于经常不写字,好多字不会写,导致用五笔打不出来,而且从长远看好像用拼音会更有优势,所以决定转到拼音去.转换过程并没有想象中的困难,只花了差不多一个月就已经到可用的状态了. 但是尴尬的是我发现小学时候拼音没学好,好多字还是打不出来:(, 不过不打算在转回五笔了.事实证明,很多看起来有难度的事情,只要有一个契机,加小小的坚持,还是可以完成的.</p>

<h3>领悟</h3>

<blockquote><p>千里之行始于足下</p>

<p>只要功夫深铁杵磨成针</p>

<p>聪明在于勤奋，天才在于积累</p>

<p>&hellip;</p></blockquote>

<p>有太多关于积累的名言警句,但大部分人都是听听就好了,没有更深刻的认识,因为这些都是别人总结出来的,是别人的不是自己的.人们都说长时间不吃饭会很饿,我们听了后会觉的, 好像很有道理哦,直到自己饿了好多天没吃才会想,长时间不吃饭TM会很饿呀; 刚上大学的时候就听到有人说不要挂科,不让会很惨,当时听到也觉的好像很有道理,直到我因为挂了太多课,拿不到学位证才发现,TM挂科真的很惨呀.所有很多大道理,鸡汤,自己不体会一下是不会有直观的体验的.</p>

<p>刚开始用百词斩背单词的时候并不会想到会坚持400多天,当时只是天真的想,等我坚持背100天的时候发朋友圈里,别人一定会觉得我很牛B.可是到坚持100多天的时候并不是很想分享到朋友圈,反倒是深刻的明白了一个道理:习惯真的太有用了,试想,如果我一直坚持背单词,最好形成习惯,那单词量增加不过是时间问题,在试想,如果我一年前,或五年前,十年前就有这个习惯,那我现在单词量岂不是已经很足了?</p>

<p>在把这个发现推广到其他地方,如果我很早就有每天运动的习惯,哪怕是最简单的俯卧撑,仰卧起坐之类的,坚持多年后体质也一定会有非常明显的,在比如有早睡早起,生活规律的习惯,那现在头发也应该不会掉的这么严重,如果很早就有做事认真的习惯,那今年就不会出这么多Bug了,为什么现在才明白过来?</p>

<p>突然想起上初中的时候有一个数学老师给我们讲了一个故事: 有一个人养了一头猪下了一窝小猪,其中有一只腿有缺陷站不起来,每只给猪喂食的时候这个人都是从耳朵上把这头小猪提过去吃,完了再提回去,等这头猪长到200多斤的时候,这个人可以单手提起200斤的重物.
当时听完后好像很有感触,然后就没有然后了.现在想想,如果当时能明白过来,从那时候就注重培养一些好习惯,现在岂不是已经很牛逼了?</p>

<p>不过迟点明白过来总比还没明白过来好,所以接下来的一年我回把养成好习惯放在最重要的位置;为此我还专门开发了一个网页程序: <a href="https://github.com/williamherry/habit,">https://github.com/williamherry/habit,</a> 部署在heroku上: <a href="http://habit.williamherry.com/,">http://habit.williamherry.com/,</a> 现在除了背单词以为已经有几个习惯稳定下来了,像做仰卧起坐已经坚持了100多天了吧,从原来的一口气做30个到现在已经可以一口气做140个</p>

<p><b>习惯才是最大的财富</b></p>

<h3>吉他 &amp;&amp; 高音</h3>

<p>练吉他和高音的任务远远没有完成,究其原因,之前一直习惯于做一件事想马上看到结果,看到提高,但实际上大多事情都是需要靠时间来磨的,积累足够的量变才会引起质变.所以要能学会弹一首曲子,首先得养成每天都弹弹的习惯,不过习惯也不是说想养成就可以养成的,也是需要磨时间的,鉴于已经有一些习惯正在进行中,这个只能排的后一点了,另外现在有室友了,练习会影响到他</p>

<h2>2015年计划</h2>

<p>2015年只有一件很重要的事情需要完成: 养成尽可能多的好习惯</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/10/memcached-cache-analysis/">Memcached Cache Analysis</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-10T22:55:00+08:00" pubdate data-updated="true">Sep 10<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/09/10/memcached-cache-analysis/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>利用munin这样的工具可以查看到Memcached整个缓存的命中率,有时候可能会需要知道不同的缓存各自的命中率如何,这时候可以利用Rails的<a href="http://edgeguides.rubyonrails.org/active_support_instrumentation.html#active-support">ActiveSupport::Notifications</a>来帮助我们分析</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CacheLogger = Logger.new("log/cache.log")
</span><span class='line'>
</span><span class='line'>ActiveSupport::Notifications.subscribe /cache_\S*\.active_support/ do |name, start, finish, id, payload|
</span><span class='line'>  CacheLogger.info "#{name} #{start} #{payload[:key]}"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>上面的代码会把所有的缓存的请求记录到一个日志文件里面,可以用下面的脚本去生产分析报告(from @soffolk)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#! /bin/sh
</span><span class='line'>
</span><span class='line'># ./parse_cache cache.log courses
</span><span class='line'>
</span><span class='line'>read=`cat $1 | grep $2 | grep cache_read.active_support | wc -l`
</span><span class='line'>write=`cat $1 | grep $2 | grep cache_write.active_support | wc -l`
</span><span class='line'>read_multi=`cat $1 | grep $2 | grep cache_read_multi.active_support | grep -o '[as|to]-json' | wc -l`
</span><span class='line'>fetch_hit=`cat $1 | grep $2 | grep cache_fetch_hit.active_support | wc -l`
</span><span class='line'>all=$((read+read_multi))
</span><span class='line'>if [ $all = 0 ]; then
</span><span class='line'>  ratio=0
</span><span class='line'>else
</span><span class='line'>  ratio=$(echo "scale=6; $(($all-$write))/$all*100" | bc -l)
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>echo "Read:         $read"
</span><span class='line'>echo "Write:        $write"
</span><span class='line'>echo "Read Multi:   $read_multi"
</span><span class='line'>echo "Fetch Hit:    $fetch_hit"
</span><span class='line'>echo "All:          $all"
</span><span class='line'>echo "Hit Ratio:    $ratio%"</span></code></pre></td></tr></table></div></figure>


<p>另外你可能想看一下是不是分给Memcached的内存已经用光了,不断有少访问的item被挤出去</p>

<p>可以用memcdump命令dump出所有的keys</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>memcdump --servers=localhost | sort &gt; keys1.dump</span></code></pre></td></tr></table></div></figure>


<p>过几秒在dump一次</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>memcdump --servers=localhost | sort &gt; keys2.dump</span></code></pre></td></tr></table></div></figure>


<p>使用comm命令可以查看是否有变化</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>comm -23 keys1.dump keys2.dump &gt; only_in_one.dump
</span><span class='line'>comm -13 keys1.dump keys2.dump &gt; only_in_two.dump</span></code></pre></td></tr></table></div></figure>


<p>实际上从memcached的内置命令stats就可以看到内存已经不够用的,一直有item被挤出去</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>STAT hash_is_expanding 0
</span><span class='line'>STAT expired_unfetched 4383
</span><span class='line'>STAT evicted_unfetched 7335517 #已驱逐但未获取的对象数目 
</span><span class='line'>STAT bytes 253815528
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/22/login-from-console/">Login From Console</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-22T14:42:00+08:00" pubdate data-updated="true">Aug 22<span>nd</span>, 2014</time>
        
         | <a href="/blog/2014/08/22/login-from-console/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近有一个问题调试了好久,这个过程中学的了一些有意思的调试方法,在这里记录一下过程</p>

<p>问题是出现在staging环境上的,有一个form已提交就报错,只有那一条数据有这个错误,
但是单独肉眼看没发现有什么问题,查看日志只有很少的错误信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ActiveRecord::RecordNotSaved (ActiveRecord::RecordNotSaved):
</span><span class='line'>  app/forms/my_form.rb:51:in `submit'
</span><span class='line'>  app/controllers/my_controller.rb:60:in `update'</span></code></pre></td></tr></table></div></figure>


<p><code>app/forms/my_form.rb</code>的51行是</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>my_object.save!</span></code></pre></td></tr></table></div></figure>


<p>判断是没保存成功,由于不是在本地开发模式,不能用pry设置断点,只能打印出来了</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>begin
</span><span class='line'>  my_object.save
</span><span class='line'>rescue ActiveRecord::RecordNotSaved =&gt; e
</span><span class='line'>  Rails.logger.info my_object.errors.full_messages
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>结果什么错误信息也没有,搜索了一下这个错误提示,有人说callback返回false会引起保存不成功并没有错误,例如有这样一个callback</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def hide
</span><span class='line'>  self.visible = false
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>但这个model并没有这样的Callback,把全部callback都删掉问题依旧,所以判断不是这个问题</p>

<p>同事支招把backtrace打出来会不会看出点眉目</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>begin
</span><span class='line'>  my_object.save
</span><span class='line'>rescue ActiveRecord::RecordNotSaved =&gt; e
</span><span class='line'>  Rails.logger.info $!.inspect, $@
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>错误信息是多了,但任然看不出问题所在,由于经常用pry断点调试,现在已经没办法了,搜索怎么在非development环境用pry</p>

<p>这个过程中学会了怎么在console里发请求如登陆什么的</p>

<p>引用 <a href="http://stackoverflow.com/questions/151030/how-do-i-call-controller-view-methods-from-the-console-in-rails">http://stackoverflow.com/questions/151030/how-do-i-call-controller-view-methods-from-the-console-in-rails</a> 的最后一个答案</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Start Rails console
</span><span class='line'>rails console
</span><span class='line'># Disable forgery_protection
</span><span class='line'>ApplicationController.allow_forgery_protection = false
</span><span class='line'># Get the login form
</span><span class='line'>app.get '/community_members/sign_in'
</span><span class='line'># View the session
</span><span class='line'>app.session.to_hash
</span><span class='line'># Copy the CSRF token "_csrf_token" and place it in the login request.
</span><span class='line'># Log in from the console to create a session
</span><span class='line'>app.post '/community_members/login', {"authenticity_token"=&gt;"gT7G17RNFaWUDLC6PJGapwHk/OEyYfI1V8yrlg0lHpM=",  "refinery_user[login]"=&gt;'chloe', 'refinery_user[password]'=&gt;'test'}
</span><span class='line'># View the session to verify CSRF token is the same
</span><span class='line'>app.session.to_hash
</span><span class='line'># Copy the CSRF token "_csrf_token" and place it in the request. It's best to edit this in Notepad++
</span><span class='line'>app.post '/refinery/blog/posts', {"authenticity_token"=&gt;"gT7G17RNFaWUDLC6PJGapwHk/OEyYfI1V8yrlg0lHpM=", "switch_locale"=&gt;"en", "post"=&gt;{"title"=&gt;"Test", "homepage"=&gt;"0", "featured"=&gt;"0", "magazine"=&gt;"0", "refinery_category_ids"=&gt;["1282"], "body"=&gt;"Tests do a body good.", "custom_teaser"=&gt;"", "draft"=&gt;"0", "tag_list"=&gt;"", "published_at(1i)"=&gt;"2014", "published_at(2i)"=&gt;"5", "published_at(3i)"=&gt;"27", "published_at(4i)"=&gt;"21", "published_at(5i)"=&gt;"20", "custom_url"=&gt;"", "source_url_title"=&gt;"", "source_url"=&gt;"", "user_id"=&gt;"56", "browser_title"=&gt;"", "meta_description"=&gt;""}, "continue_editing"=&gt;"false", "locale"=&gt;:en}</span></code></pre></td></tr></table></div></figure>


<p>登陆可以了但断点还是不行, 不过<a href="http://stackoverflow.com/questions/7744848/is-there-a-way-to-identify-why-the-database-rollsback-in-a-rails-application">http://stackoverflow.com/questions/7744848/is-there-a-way-to-identify-why-the-database-rollsback-in-a-rails-application</a> 的回答给了我灵感,保存不成功日志里会有rollback, 所以我修改了日志配置,果然发现了原因,原来是关联的model缺字段保存没成功</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/11/learning-chef-ohai-source-code/">Chef Ohai源码学习</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-11T08:28:00+08:00" pubdate data-updated="true">Feb 11<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/02/11/learning-chef-ohai-source-code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>接触Chef以来一直对Ohai很感兴趣,它收集的系统信息非常全面,很好奇它是怎么收集的,现在终于有时间学习了</p>

<h3>目标</h3>

<p>搞清楚Ohai是如何收集到某一项系统消息的,如IP地址</p>

<h3>环境搭建</h3>

<p>使用<code>gem install ohai</code>安装ohai和它的依赖,然后下载ohai的源码</p>

<pre><code>git clone https://github.com/opscode/ohai.git
</code></pre>

<p>可以直接在源码目录通过<code>./bin/ohai</code>运行<code>ohai</code>,这样可以对源码做一些修改(添加调试代码)然后马上运行查看效果,而不用去找它的源码安装到系统的位置</p>

<p>还可以使用<code>pry</code>进行单步调试: <code>gem install pry</code>安装<code>pry</code>,的要调试的代码前面加上<code>binding.pry</code>,在该文件前面加上<code>require 'pry'</code></p>

<h3>查看源码过程</h3>

<p>首先找到入口,当然就是<code>bin/ohai</code>文件了,我们需要关系的只有一行</p>

<figure class='code'><figcaption><span>bin/ohai</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们在看一下<code>Ohai::Application</code>的定义,我们感兴趣的是<code>run</code>方法的定义</p>

<figure class='code'><figcaption><span>lib/ohai/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>  <span class="n">configure_ohai</span>
</span><span class='line'>  <span class="n">configure_logging</span>
</span><span class='line'>  <span class="n">run_application</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里前两个方法我们目前不关心,看一下<code>run_application</code>方法的定义</p>

<figure class='code'><figcaption><span>lib/ohai/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run_application</span>
</span><span class='line'>  <span class="n">ohai</span> <span class="o">=</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:System</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">ohai</span><span class="o">.</span><span class="n">all_plugins</span><span class="p">(</span><span class="vi">@attributes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@attributes</span>
</span><span class='line'>    <span class="vi">@attributes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">ohai</span><span class="o">.</span><span class="n">attributes_print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">ohai</span><span class="o">.</span><span class="n">json_pretty_print</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过加调试代码发现这里的<code>@attributes</code>是nil,所以这里的代码可以简化为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ohai</span> <span class="o">=</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:System</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">ohai</span><span class="o">.</span><span class="n">all_plugins</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">ohai</span><span class="o">.</span><span class="n">json_pretty_print</span>
</span></code></pre></td></tr></table></div></figure>


<p>下来去看<code>Ohai::System</code>的定义</p>

<p>首先我们看一下<code>json_pretty_print</code>的定义</p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">json_pretty_print</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">Yajl</span><span class="p">:</span><span class="ss">:Encoder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:pretty</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span> <span class="o">||</span> <span class="vi">@data</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>它只是把<code>@data</code>的数据格式化后输出,所以我们推测实际收集的动作是发生在<code>all_plugins</code>方法里</p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">all_plugins</span><span class="p">(</span><span class="n">attribute_filter</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Reset the system when all_plugins is called since this function</span>
</span><span class='line'>  <span class="c1"># can be run multiple times in order to pick up any changes in the</span>
</span><span class='line'>  <span class="c1"># config or plugins with Chef.</span>
</span><span class='line'>  <span class="n">reset_system</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">load_plugins</span>
</span><span class='line'>  <span class="n">run_plugins</span><span class="p">(</span><span class="kp">true</span><span class="p">,</span> <span class="n">attribute_filter</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>reset_system</code>方法里只是初始化了一些实例变量,其中包括<code>@loader</code>它<code>@runner</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@loader</span> <span class="o">=</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Loader</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'><span class="vi">@runner</span> <span class="o">=</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Runner</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里把<code>self</code>传了进去,这里的<code>self</code>就就<code>Ohai::System</code>的实例,我们看一下loader如何处理</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@controller</span> <span class="o">=</span> <span class="n">controller</span>
</span><span class='line'>  <span class="vi">@v6_plugin_classes</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="vi">@v7_plugin_classes</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>loader把<code>Ohai::System</code>的实例保存到了实例变量<code>@controller</code>中</p>

<p><code>load_plugins</code>方法只有一行,调用了<code>@loader</code>的<code>load_all</code>方法,我们看一下这个方法</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_all</span>
</span><span class='line'>  <span class="n">plugin_files_by_dir</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin_file</span><span class="o">|</span>
</span><span class='line'>    <span class="n">load_plugin_class</span><span class="p">(</span><span class="n">plugin_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">plugin_file</span><span class="o">.</span><span class="n">plugin_root</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">collect_v6_plugins</span>
</span><span class='line'>  <span class="n">collect_v7_plugins</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>看一下<code>plugin_files_by_dir</code>的定义</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">plugin_files_by_dir</span>
</span><span class='line'>  <span class="nb">Array</span><span class="p">(</span><span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:plugin_path</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin_files</span><span class="p">,</span> <span class="n">plugin_path</span><span class="o">|</span>
</span><span class='line'>    <span class="n">plugin_files</span> <span class="o">+</span> <span class="no">PluginFile</span><span class="o">.</span><span class="n">find_all_in</span><span class="p">(</span><span class="n">plugin_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>注释中说它搜索所有的plugin路径并返回一个包含<code>PluginFile</code>对象的数组</p>

<p>在看一下<code>PluginFile</code>对象长什么样子</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PluginFile</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:path</span><span class="p">,</span> <span class="ss">:plugin_root</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_all_in</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">[</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_dir</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*.rb&quot;</span><span class="p">)</span><span class="o">].</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>      <span class="kp">new</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">plugin_dir</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到它只是简单的从<code>Struct</code>继承而来,这里所起的作用就是定义了两个访问器<code>path</code>和<code>plugin_root</code>,打印出来类似这样</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#&lt;struct Ohai::Loader::PluginFile</span>
</span><span class='line'> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/aix/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="n">plugin_root</span><span class="o">=</span><span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins&quot;</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>再回到<code>load_all</code>方法</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_all</span>
</span><span class='line'>  <span class="n">plugin_files_by_dir</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin_file</span><span class="o">|</span>
</span><span class='line'>    <span class="n">load_plugin_class</span><span class="p">(</span><span class="n">plugin_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">plugin_file</span><span class="o">.</span><span class="n">plugin_root</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">collect_v6_plugins</span>
</span><span class='line'>  <span class="n">collect_v7_plugins</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>对每一个<code>PluginFile</code>对象调用了<code>load_plugin_class</code>方法</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_plugin_class</span><span class="p">(</span><span class="n">plugin_path</span><span class="p">,</span> <span class="n">plugin_dir_path</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># Read the contents of the plugin to understand if it&#39;s a V6 or V7 plugin.</span>
</span><span class='line'>  <span class="n">contents</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="n">contents</span> <span class="o">&lt;&lt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">plugin_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">IOError</span><span class="p">,</span> <span class="ss">Errno</span><span class="p">:</span><span class="ss">:ENOENT</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unable to open or read plugin at </span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># We assume that a plugin is a V7 plugin if it contains Ohai.plugin in its contents.</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">contents</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;Ohai.plugin&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">load_v7_plugin_class</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">plugin_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;[DEPRECATION] Plugin at </span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2"> is a version 6 plugin. \</span>
</span><span class='line'><span class="s2">Version 6 plugins will not be supported in future releases of Ohai. \</span>
</span><span class='line'><span class="s2">Please upgrade your plugin to version 7 plugin syntax. \</span>
</span><span class='line'><span class="s2">For more information visit here: docs.opscode.com/ohai_custom.html&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">load_v6_plugin_class</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">plugin_path</span><span class="p">,</span> <span class="n">plugin_dir_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>他把文件里的内容读了进来,并根据有没有包含<code>Ohai.plugin</code>来有选择了调用<code>load_v7_plugin_class</code>或<code>load_v6_plugin_class</code>,我大概看来一下基本上全都包含<code>Ohai.plugin</code>,所以我们从v7追</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_v7_plugin_class</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">plugin_path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin_class</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="no">TOPLEVEL_BINDING</span><span class="p">,</span> <span class="n">plugin_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">plugin_class</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span> <span class="ow">and</span> <span class="n">plugin_class</span> <span class="o">&lt;</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:DSL</span><span class="o">::</span><span class="no">Plugin</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">IllegalPluginDefinition</span><span class="p">,</span> <span class="s2">&quot;Plugin file cannot contain any statements after the plugin definition&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">plugin_class</span><span class="o">.</span><span class="n">sources</span> <span class="o">&lt;&lt;</span> <span class="n">plugin_path</span>
</span><span class='line'>  <span class="vi">@v7_plugin_classes</span> <span class="o">&lt;&lt;</span> <span class="n">plugin_class</span> <span class="k">unless</span> <span class="vi">@v7_plugin_classes</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">plugin_class</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin_class</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">SystemExit</span><span class="p">,</span> <span class="no">Interrupt</span>
</span><span class='line'>  <span class="k">raise</span>
</span><span class='line'><span class="k">rescue</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">InvalidPluginName</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Plugin Name Error: &lt;</span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2">&gt;: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">IllegalPluginDefinition</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Plugin Definition Error: &lt;</span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2">&gt;: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">NoMethodError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Plugin Method Error: &lt;</span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2">&gt;: unsupported operation </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">SyntaxError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="c1"># split on occurrences of</span>
</span><span class='line'>  <span class="c1">#    &lt;env&gt;: syntax error,</span>
</span><span class='line'>  <span class="c1">#    &lt;env&gt;:##: syntax error,</span>
</span><span class='line'>  <span class="c1"># to remove from error message</span>
</span><span class='line'>  <span class="n">parts</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/&lt;.*&gt;[:[0-9]+]*: syntax error, /</span><span class="p">)</span>
</span><span class='line'>  <span class="n">parts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">part</span><span class="o">|</span>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Plugin Syntax Error: &lt;</span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2">&gt;: </span><span class="si">#{</span><span class="n">part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">Exception</span><span class="p">,</span> <span class="ss">Errno</span><span class="p">:</span><span class="ss">:ENOENT</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Plugin Error: &lt;</span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2">&gt;: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plugin Error: &lt;</span><span class="si">#{</span><span class="n">plugin_path</span><span class="si">}</span><span class="s2">&gt;: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>异常处理我们不关心,直接删掉来看</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_v7_plugin_class</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">plugin_path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin_class</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="no">TOPLEVEL_BINDING</span><span class="p">,</span> <span class="n">plugin_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">plugin_class</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span> <span class="ow">and</span> <span class="n">plugin_class</span> <span class="o">&lt;</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:DSL</span><span class="o">::</span><span class="no">Plugin</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">IllegalPluginDefinition</span><span class="p">,</span> <span class="s2">&quot;Plugin file cannot contain any statements after the plugin definition&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">plugin_class</span><span class="o">.</span><span class="n">sources</span> <span class="o">&lt;&lt;</span> <span class="n">plugin_path</span>
</span><span class='line'>  <span class="vi">@v7_plugin_classes</span> <span class="o">&lt;&lt;</span> <span class="n">plugin_class</span> <span class="k">unless</span> <span class="vi">@v7_plugin_classes</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">plugin_class</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin_class</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里第一行把插件文件里的代码执行,返回的结果赋给<code>plugin_class</code>,把<code>plugin_path</code>保存到其中,并把它收集到实例变量<code>@v7_plugin_classes</code>中</p>

<p>我们找最简单了plugin看里面是什么</p>

<figure class='code'><figcaption><span>lib/ohai/plugins/command.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Ohai</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:Command</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provides</span> <span class="s2">&quot;command&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">collect_data</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">command</span> <span class="no">Mash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>它是调用<code>Ohai</code>的<code>plugin</code>方法,还传给它一个block,看看这个方法的定义</p>

<figure class='code'><figcaption><span>lib/ohai/dsl/plugin.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">plugin</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">raise</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">InvalidPluginName</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> is not a valid plugin name. A valid plugin name is a symbol which begins with a capital letter and contains no underscores&quot;</span> <span class="k">unless</span> <span class="no">NamedPlugin</span><span class="o">.</span><span class="n">valid_name?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">plugin</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="no">NamedPlugin</span><span class="o">.</span><span class="n">strict_const_defined?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">plugin</span> <span class="o">=</span> <span class="no">NamedPlugin</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">plugin</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">klass</span> <span class="o">=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">DSL</span><span class="p">:</span><span class="ss">:Plugin</span><span class="o">::</span><span class="no">VersionVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="n">plugin</span> <span class="o">=</span> <span class="no">NamedPlugin</span><span class="o">.</span><span class="n">const_set</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">plugin</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法重点是这两行</p>

<figure class='code'><figcaption><span>lib/ohai/dsl/plugin.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">klass</span> <span class="o">=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">DSL</span><span class="p">:</span><span class="ss">:Plugin</span><span class="o">::</span><span class="no">VersionVII</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'><span class="n">plugin</span> <span class="o">=</span> <span class="no">NamedPlugin</span><span class="o">.</span><span class="n">const_set</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>第一行用传进来了block创建了一个继承自<code>DSL::Plugin::VersionVII</code>的类,然后一传进来的<code>name</code>为常量名保存到模块<code>NamedPlugin</code>中</p>

<p>我们在回到前面的plugin文件</p>

<figure class='code'><figcaption><span>lib/ohai/plugins/command.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Ohai</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:Command</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provides</span> <span class="s2">&quot;command&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">collect_data</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">command</span> <span class="no">Mash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里还有两个方法<code>provides</code>和<code>collect_data</code>,你没有猜错,它们就是定义在继承来的<code>DSL::Plugin::VersionVII</code>中</p>

<figure class='code'><figcaption><span>lib/ohai/dsl/plugin/versionvii.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">provides</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
</span><span class='line'>  <span class="n">attrs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span>
</span><span class='line'>    <span class="n">provides_attrs</span> <span class="o">&lt;&lt;</span> <span class="kp">attr</span> <span class="k">unless</span> <span class="n">provides_attrs</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="kp">attr</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>它只是它传进来的参数收集到<code>provides_atts</code>,而<code>provides_atts</code>是前面生成的类的实例变量</p>

<figure class='code'><figcaption><span>lib/ohai/dsl/plugin/versionvii.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">provides_attrs</span>
</span><span class='line'>  <span class="vi">@provides_attrs</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在看<code>collect_data</code></p>

<figure class='code'><figcaption><span>lib/ohai/dsl/plugin/versionvii.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">collect_data</span><span class="p">(</span><span class="n">platform</span> <span class="o">=</span> <span class="ss">:default</span><span class="p">,</span> <span class="o">*</span><span class="n">other_platforms</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="o">[</span><span class="n">platform</span><span class="p">,</span> <span class="n">other_platforms</span><span class="o">].</span><span class="n">flatten</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plat</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">data_collector</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">plat</span><span class="p">)</span>
</span><span class='line'>      <span class="k">raise</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">IllegalPluginDefinition</span><span class="p">,</span> <span class="s2">&quot;collect_data already defined on platform </span><span class="si">#{</span><span class="n">plat</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">data_collector</span><span class="o">[</span><span class="n">plat</span><span class="o">]</span> <span class="o">=</span> <span class="n">block</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于前面的plugin中调用这个方法的时候只传了一个快进来,所从这个方法只是把传进来了块赋值给了以<code>:default</code>为key的<code>Mash</code>对象<code>data_collector</code>中</p>

<figure class='code'><figcaption><span>lib/ohai/dsl/plugin/versionvii.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">data_collector</span>
</span><span class='line'>  <span class="vi">@data_collector</span> <span class="o">||=</span> <span class="no">Mash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们再一次回到<code>load_all</code>方法中</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_all</span>
</span><span class='line'>  <span class="n">plugin_files_by_dir</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin_file</span><span class="o">|</span>
</span><span class='line'>    <span class="n">load_plugin_class</span><span class="p">(</span><span class="n">plugin_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">plugin_file</span><span class="o">.</span><span class="n">plugin_root</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">collect_v6_plugins</span>
</span><span class='line'>  <span class="n">collect_v7_plugins</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>还剩下两行代码,我们只看一下<code>collect_v7_plugins</code></p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">collect_v7_plugins</span>
</span><span class='line'>  <span class="vi">@v7_plugin_classes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin_class</span><span class="o">|</span>
</span><span class='line'>    <span class="n">load_v7_plugin</span><span class="p">(</span><span class="n">plugin_class</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>对收集的<code>plugin_class</code>调用<code>load_v7_plugin</code>方法</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_v7_plugin</span><span class="p">(</span><span class="n">plugin_class</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin</span> <span class="o">=</span> <span class="n">plugin_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@controller</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="n">collect_provides</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法把传进来的类实例化,并把<code>Ohai::System</code>实例的data传了进去,然后调用了<code>collect_provides</code></p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">collect_provides</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin_provides</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">provides_attrs</span>
</span><span class='line'>  <span class="vi">@controller</span><span class="o">.</span><span class="n">provides_map</span><span class="o">.</span><span class="n">set_providers_for</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">plugin_provides</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>还记得前面最简单的plugin的代码吗,这里的<code>plugin.class.provides_attrs</code>就是<code>provides</code>后面的参数(&ldquo;command&rdquo;)</p>

<p>这里的provides_map是在<code>Ohai::System</code>的<code>reset_system</code>赋值的,是<code>ProvidesMap</code>的实例</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@provides_map</span> <span class="o">=</span> <span class="no">ProvidesMap</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后它又调用了<code>set_providers_for</code>方法</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">set_providers_for</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">provided_attributes</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">plugin</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="ss">Ohai</span><span class="p">:</span><span class="ss">:DSL</span><span class="o">::</span><span class="no">Plugin</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;set_providers_for only accepts Ohai Plugin classes (got: </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">provided_attributes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute</span><span class="o">|</span>
</span><span class='line'>    <span class="n">attrs</span> <span class="o">=</span> <span class="vi">@map</span>
</span><span class='line'>    <span class="n">parts</span> <span class="o">=</span> <span class="n">normalize_and_validate</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
</span><span class='line'>    <span class="n">parts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">part</span><span class="o">|</span>
</span><span class='line'>      <span class="n">attrs</span><span class="o">[</span><span class="n">part</span><span class="o">]</span> <span class="o">||=</span> <span class="no">Mash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">[</span><span class="n">part</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">attrs</span><span class="o">[</span><span class="ss">:_plugins</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">attrs</span><span class="o">[</span><span class="ss">:_plugins</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">plugin</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里把传来的keys它plugin收集到了providesmap的实例变量<code>@map</code>中,类似这样</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="c1">#&lt;Ohai::ProvidesMap&gt;)&gt; @map</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="p">{</span><span class="s2">&quot;cpu&quot;</span><span class="o">=&gt;</span>
</span><span class='line'>     <span class="p">{</span><span class="s2">&quot;_plugins&quot;</span><span class="o">=&gt;</span>
</span><span class='line'>       <span class="o">[</span><span class="c1">#&lt;Ohai::NamedPlugin::CPU:0x00000101a6a4d0</span>
</span><span class='line'>         <span class="vi">@data</span><span class="o">=</span><span class="p">{},</span>
</span><span class='line'>         <span class="vi">@has_run</span><span class="o">=</span><span class="kp">false</span><span class="p">,</span>
</span><span class='line'>         <span class="vi">@source</span><span class="o">=</span>
</span><span class='line'>           <span class="o">[</span><span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/aix/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/darwin/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/freebsd/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/linux/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/netbsd/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/openbsd/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/sigar/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/solaris2/cpu.rb&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s2">&quot;/Users/william/Codes/ohai/lib/ohai/plugins/windows/cpu.rb&quot;</span>
</span><span class='line'>           <span class="o">]</span><span class="p">,</span>
</span><span class='line'>         <span class="vi">@version</span><span class="o">=</span><span class="ss">:version7</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="o">]</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们再回到<code>all_plugins</code>方法,前面是<code>load_plugins</code>方法的深入执行过程,现在来看<code>run_plugins</code>方法</p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run_plugins</span><span class="p">(</span><span class="n">safe</span> <span class="o">=</span> <span class="kp">false</span><span class="p">,</span> <span class="n">attribute_filter</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># First run all the version 6 plugins</span>
</span><span class='line'>  <span class="vi">@v6_dependency_solver</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v6plugin</span><span class="o">|</span>
</span><span class='line'>    <span class="vi">@runner</span><span class="o">.</span><span class="n">run_plugin</span><span class="p">(</span><span class="n">v6plugin</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Then run all the version 7 plugins</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="vi">@provides_map</span><span class="o">.</span><span class="n">all_plugins</span><span class="p">(</span><span class="n">attribute_filter</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span>
</span><span class='line'>      <span class="vi">@runner</span><span class="o">.</span><span class="n">run_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">AttributeNotFound</span><span class="p">,</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">DependencyCycle</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Encountered error while running plugins: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们只看v7的,这里比较简单,对每一个plugin调用<code>@runner</code>的<code>run_plugin</code>方法(<code>@runner</code>)是在<code>reset_system</code>中定义的</p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">plugin</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="ss">Ohai</span><span class="p">:</span><span class="ss">:DSL</span><span class="o">::</span><span class="no">Plugin</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">InvalidPlugin</span><span class="p">,</span> <span class="s2">&quot;Invalid plugin </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> (must be an Ohai::DSL::Plugin or subclass)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:disabled_plugins</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="n">plugin</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping disabled plugin </span><span class="si">#{</span><span class="n">plugin</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">plugin</span><span class="o">.</span><span class="n">version</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:version7</span>
</span><span class='line'>      <span class="n">run_v7_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>    <span class="k">when</span> <span class="ss">:version6</span>
</span><span class='line'>      <span class="n">run_v6_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">InvalidPlugin</span><span class="p">,</span> <span class="s2">&quot;Invalid plugin version </span><span class="si">#{</span><span class="n">plugin</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2"> for plugin </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">Error</span>
</span><span class='line'>    <span class="k">raise</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">Exception</span><span class="p">,</span><span class="ss">Errno</span><span class="p">:</span><span class="ss">:ENOENT</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plugin </span><span class="si">#{</span><span class="n">plugin</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> threw exception </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>简单说它就是转而去调用<code>run_v7_plugin</code></p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run_v7_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>  <span class="n">visited</span> <span class="o">=</span> <span class="o">[</span> <span class="n">plugin</span> <span class="o">]</span>
</span><span class='line'>  <span class="k">while</span> <span class="o">!</span><span class="n">visited</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="n">next_plugin</span> <span class="o">=</span> <span class="n">visited</span><span class="o">.</span><span class="n">pop</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">next</span> <span class="k">if</span> <span class="n">next_plugin</span><span class="o">.</span><span class="n">has_run?</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">visited</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">next_plugin</span><span class="p">)</span>
</span><span class='line'>      <span class="k">raise</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">DependencyCycle</span><span class="p">,</span> <span class="s2">&quot;Dependency cycle detected. Please refer to the following plugins: </span><span class="si">#{</span><span class="n">get_cycle</span><span class="p">(</span><span class="n">visited</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span> <span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dependency_providers</span> <span class="o">=</span> <span class="n">fetch_plugins</span><span class="p">(</span><span class="n">next_plugin</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Remove the already ran plugins from dependencies if force is not set</span>
</span><span class='line'>    <span class="c1"># Also remove the plugin that we are about to run from dependencies as well.</span>
</span><span class='line'>    <span class="n">dependency_providers</span><span class="o">.</span><span class="n">delete_if</span> <span class="p">{</span> <span class="o">|</span><span class="n">dep_plugin</span><span class="o">|</span>
</span><span class='line'>      <span class="n">dep_plugin</span><span class="o">.</span><span class="n">has_run?</span> <span class="o">||</span> <span class="n">dep_plugin</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="n">next_plugin</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">dependency_providers</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="vi">@safe_run</span> <span class="p">?</span> <span class="n">next_plugin</span><span class="o">.</span><span class="n">safe_run</span> <span class="p">:</span> <span class="n">next_plugin</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">visited</span> <span class="o">&lt;&lt;</span> <span class="n">next_plugin</span> <span class="o">&lt;&lt;</span> <span class="n">dependency_providers</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>简单说就是去调用plugin自己的<code>safe_run</code>方法(因为在定义@runner的时候有传第二个参数true)</p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">safe_run</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">raise</span> <span class="n">e</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Plugin </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> threw </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">line</span> <span class="p">)}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>它又调用了<code>run</code>方法</p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>  <span class="vi">@has_run</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">run_plugin</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>它又调用了<code>run_plugin</code>方法,这个方法是在<code>lib/ohai/dsl/plugin/versionvii.rb</code>中定义的</p>

<figure class='code'><figcaption><span>lib/ohai/system.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run_plugin</span>
</span><span class='line'>  <span class="n">collector</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">data_collector</span>
</span><span class='line'>  <span class="n">platform</span> <span class="o">=</span> <span class="n">collect_os</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">collector</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">collector</span><span class="o">[</span><span class="n">platform</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">collector</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:default</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">collector</span><span class="o">[</span><span class="ss">:default</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="ss">Ohai</span><span class="p">:</span><span class="ss">:Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No data to collect for plugin </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. Continuing...&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>它用<code>instance_eval</code>执行了前面动态构造Plugin类的时候保存下来的块(collect_data后面跟的块)</p>

<p>整个过程过了一遍,但有一点还没明白,最开始的地方我们发现显示出来的信息都收集在<code>Ohai::System</code>的实例<code>@ohai</code>的实例变量<code>@data</code>里,执行插件里的代码怎么会修改到它呢?</p>

<p>这是因为在实例化plugin的时候它把实例变量<code>@data</code>传了进去</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">load_v7_plugin</span><span class="p">(</span><span class="n">plugin_class</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin</span> <span class="o">=</span> <span class="n">plugin_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@controller</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="n">collect_provides</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</span><span class='line'>  <span class="n">plugin</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在看一下plugin的部分代码</p>

<figure class='code'><figcaption><span>lib/ohai/loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Ohai</span><span class="o">.</span><span class="n">plugin</span><span class="p">(</span><span class="ss">:Command</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provides</span> <span class="s2">&quot;command&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">collect_data</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">command</span> <span class="no">Mash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>传给<code>collect_data</code>的块中的command是不是很奇怪,它是个什么东西?</p>

<p>答案的下面的代码中</p>

<figure class='code'><figcaption><span>lib/ohai/dsl/plugin.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">get_attribute</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">set_attribute</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@data</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>到此所有迷雾都解开了, Yeah!!!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/01/2014-plans/">2014年规划</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-01T11:52:00+08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2014</time>
        
         | <a href="/blog/2014/01/01/2014-plans/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2013年已经在昨天划上的句号,回想过去的这一年,真的可以说收获很多:</p>

<ul>
<li>毕业两年换了三个工作,终于在去年找到了自己满意的工作,同事个个都是高手,一周还能打两次蓝球</li>
<li>终于用上了梦寐以求苹果电脑,虽然是公司配的不是自己买的,虽然Mac OSX系统没有想象中的好</li>
<li>其实最重要的是去年这一年大部分时间是过的比较开心的,快乐一直是我追求的最终目标</li>
<li>学会了发气咆音(vocal fry)和弹舌音</li>
<li>没有生病</li>
<li>学会了游泳</li>
</ul>


<p>当然去年没有做好的事情也非常多,这里就不拿出来一一示众,没有做好的原因都是自己在各方面都不够成熟强大,接下来的这一年还需要花很多的时候去修行</p>

<p>今天是2014年的每一天,正好简单列一下对这一年自己的规划,一些希望能够完成的事情.为了提高可行性,每一项都分解成小步骤</p>

<p>感觉不用多久,我就会升职加薪,当上总经理,出任CEO,迎娶白富美,走上人生巅峰,想想还有点小激动呢</p>

<ul>
<li>[x] 今天完成这个规划</li>
<li>[x] 学习吉他

<ul>
<li>[x] 首先需要买一把吉他</li>
<li>[ ] 学会&lt;她来听我的演唱会>的弹唱</li>
</ul>
</li>
<li>[ ] 读Rails源码,以问题的方式去读而不是从头一个文件一个文件的读,那样肯定完成不了

<ul>
<li>[ ] 列一些关于Rails如果实现的并且三兴趣的小问题,如:

<ul>
<li>[ ] Rails启动过程</li>
<li>[ ] 请求的处理过程</li>
</ul>
</li>
</ul>
</li>
<li>[ ] 可以轻松唱A2

<ul>
<li>[ ] 练习Brett Manning的Singing Success</li>
<li>[ ] 练习Brett Manning的Mastering Vibrato</li>
<li>[ ] 练习Brett Manning的Mastering Mix</li>
<li>[ ] 重复以上步骤走到达到目标</li>
</ul>
</li>
<li>[ ] 见一次大海

<ul>
<li>[ ] 找到最这里最近的海在哪里</li>
<li>[ ] 查找路线</li>
<li>[ ] 找假期或请假去</li>
</ul>
</li>
<li>[ ] 突破英语口语

<ul>
<li>[ ] 前半年继续用百词斩学单词,四级已经快学完了,之后背六级,再之后托福或雅思</li>
<li>[ ] 后半年可以考虑参加口语培训班</li>
</ul>
</li>
<li>[x] 早起累计超过一百天

<ul>
<li>[x] 早起后在Twiter上记录方便以后统计.完成后就可以放肆的熬夜和赖床了(第一天就睡到11点,不是好的预兆呀)</li>
</ul>
</li>
<li>[x] 学习佛教经典

<ul>
<li>[x] 先把已经买的相关的书看完:

<ul>
<li>[x] 读佛即是拜佛:六祖慧能传(已看完)</li>
<li>[x] 读佛即是拜佛:真实的唐僧</li>
<li>[x] 读佛即是拜佛:弥勒佛传</li>
<li>[x] 读佛即是拜佛:地藏菩萨传</li>
</ul>
</li>
</ul>
</li>
<li>[ ] 写5篇技术含量比较高的博客

<ul>
<li>[x] Chef Ohai源码学习</li>
</ul>
</li>
<li>[ ] 进一步深入了解Linux

<ul>
<li>[ ] 现在对Linux的了解还是停在两年前的水平,现在还没想好可行的方案,有可能会是

<ul>
<li>[ ] 读源代码,可以从openSUSE中的已经用Ruby重写了的yast开始</li>
<li>[ ] 玩开源硬件(目前一点兴趣都没有)</li>
</ul>
</li>
</ul>
</li>
<li>[ ] 读很多年前就想读但由于各种原因一直没有开始的几本书(都比较厚,可能没太多的时间,能读一本算一本了)

<ul>
<li>[ ] 算法导论</li>
<li>[ ] 代码大全</li>
<li>[ ] 编译原理(龙书)</li>
</ul>
</li>
<li>[ ] 进一步深入了解工作中遇到的或者自己感兴趣的技术或语言

<ul>
<li>[ ] Javascript

<ul>
<li>[ ] 把买的犀牛书看完,不然太浪费了</li>
</ul>
</li>
<li>[ ] Erlang

<ul>
<li>[ ] 把豆瓣上买的Erlang程序设计看完,不然太浪费了(豆瓣阅读真TM的烂)</li>
<li>[ ] 把已经买的Erlang/OTP并发编程实战看完,不然太浪费了</li>
</ul>
</li>
</ul>
</li>
<li>[x] 加入骑行队伍

<ul>
<li>[x] 买一辆公路自行车</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/29/omniauth-github-demo/">Omniauth-github使用示例</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-29T11:57:00+08:00" pubdate data-updated="true">Jul 29<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/29/omniauth-github-demo/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这篇文档简单记录一下使用omniauth-github的过程</p>

<p>这里有个能跑的代码可以clone看看效果<a href="https://github.com/williamherry/omniauth-github-demo">omniauth-github-demo</a></p>

<p>首先新建项目:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new omniauth-github-demo</span></code></pre></td></tr></table></div></figure>


<p>为了让示例看起来不是很难看,我会把bootstrap也进来:</p>

<ul>
<li>在Gemfile里加上<code>bootstrap-sass</code>然后运行bundle</li>
<li>在<code>app/assets/javascripts/application.js</code>加上<code>//= require bootstrap</code></li>
<li>在<code>app/assets/stylesheets/application.css</code>加上<code>*= require bootstrap</code></li>
</ul>


<p>下一步把<code>omniauth-github</code>Gem加进来:
&ndash; 在Gemfile里加上<code>omniauth-github</code>并执行bundle
&ndash; 新建文件<code>config/initializers/omniauth.rb</code>包含以下内容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Rails.application.config.middleware.use OmniAuth::Builder do
</span><span class='line'>  provider :github, ENV['GITHUB_KEY'], ENV['GITHUB_SECRET']
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>关于<code>ENV['GITHUB_KEY']</code>和<code>ENV['GITHUB_SECRET']</code>,需要在github上新建一个application,得到的<code>Client ID</code>和<code>Client Secret</code>就是对应的这两个东西,可以把他们写到<code>~/.bashrc</code>里面</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export GITHUB_KEY='your client id'
</span><span class='line'>export GITHUB_SECRET='your client secret'</span></code></pre></td></tr></table></div></figure>


<p>别忘了source这个文件或重新打开一个终端让显示生效</p>

<p>还要注意你新建application的时候<code>The full URL to your application's homepage</code>和<code>Your application's callback URL</code>对应的端口需要和你的服务对应,比如我这里测试用rails开的3000端口,那我就可以填<code>http://localhost:3000/auth/github</code>和<code>http://localhost:3000/auth/github/callback</code></p>

<p>下面我们需要在页面上加一个通过github登录的link,我直接写到layout里并加上一些div让bootstrap起作用</p>

<figure class='code'><figcaption><span>app/views/layouts/application.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="p">&lt;</span>body<span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>div class<span class="p">=</span><span class="s2">&quot;navbar navbar-fixed-top&quot;</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span>div class<span class="p">=</span><span class="s2">&quot;navbar-inner&quot;</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span>div class<span class="p">=</span><span class="s2">&quot;container&quot;</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">&lt;</span>div class<span class="p">=</span><span class="s2">&quot;user-nav pull-right&quot;</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="p">&lt;</span>%<span class="p">=</span> link_to <span class="s2">&quot;Github Login&quot;</span><span class="p">,</span> <span class="s2">&quot;/auth/github&quot;</span> %<span class="p">&gt;</span>
</span><span class='line'>        <span class="p">&lt;</span>/div<span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span>/div<span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span>/div<span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>/div<span class="p">&gt;</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>现在访问还看不到我们新加的内容,因为没有指定root,rails访问到的还是静态的index页面</p>

<p>演示方便我们把root改为<code>application#index</code>并加上需要的action和view</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'>root <span class="s1">&#39;application#index&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="nb">def</span> <span class="k">index</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">mkdir</span> app<span class="sr">/views/</span>application/
</span><span class='line'>touch app<span class="sr">/views/</span>application/<span class="k">index</span>.html.erb
</span></code></pre></td></tr></table></div></figure>


<p>现在应该能看到这个link了,点一下如果看类似<code>No route matches [GET] "/auth/github/callback"</code>说明已经去github做验证并把结果返回回来了</p>

<p>下一步我们需要验证完的回调</p>

<p>从上面的错误信息可以看到回调地址是<code>/auth/github/callback</code>, 所以我们在routes中加一行</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">get</span> <span class="s2">&quot;/auth/:provider/callback&quot;</span> <span class="p">=&gt;</span> <span class="s2">&quot;sessions#create&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后建立controller和action</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'>rails <span class="k">g</span> controller sessions create
</span></code></pre></td></tr></table></div></figure>


<p>如果你想看看返回的数据什么样子,可以这样写sessions#create</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="nb">def</span> create
</span><span class='line'>  raise env[<span class="s1">&#39;omniauth.auth&#39;</span>].to_yaml
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样点登录的link就会把返回的信息显示在页面上</p>

<p>得到返回数据怎么处理就看个人需要了,你可能会想建一个表保存返回的数据, 这里我们建立users表来保存用户的nickname,由于github的nickname就是用户名,是唯一的,但是考虑到以后可能会加入其它的认证如twitter,nickname就可能冲突了,所以我们还加个provider</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'>rails <span class="k">g</span> scaffold <span class="nb">User</span> nickname provider
</span><span class='line'>rake db:migrate
</span></code></pre></td></tr></table></div></figure>


<p>有了保存数据的地方,我们就可以处理返回的验证了</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="nb">def</span> create
</span><span class='line'>  auth <span class="p">=</span> request.env[<span class="s2">&quot;omniauth.auth&quot;</span>]
</span><span class='line'>  user <span class="p">=</span> <span class="nb">User</span>.find_by_omniauth<span class="p">(</span>auth<span class="p">)</span>
</span><span class='line'>  session[:user_id] <span class="p">=</span> user.id
</span><span class='line'>  redirect_to root_url<span class="p">,</span> :notice <span class="p">=&gt;</span> <span class="s2">&quot;Signed in!&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>把<code>find_by_omniauth</code>方法放到了model里,它也很简单,能找到就返回,找不到就创建</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="nb">def</span> self.find_by_omniauth<span class="p">(</span>auth<span class="p">)</span>
</span><span class='line'>  user <span class="p">=</span> <span class="nb">User</span>.find_by_provider_and_nickname<span class="p">(</span>auth[<span class="s2">&quot;provider&quot;</span>]<span class="p">,</span> auth[<span class="s2">&quot;info&quot;</span>][<span class="s2">&quot;nickname&quot;</span>]<span class="p">)</span>
</span><span class='line'>  user ? user : <span class="nb">User</span>.create_with_omniauth<span class="p">(</span>auth<span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">def</span> self.create_with_omniauth<span class="p">(</span>auth<span class="p">)</span>
</span><span class='line'>  create<span class="p">!</span> <span class="k">do</span> <span class="p">|</span>user<span class="p">|</span>
</span><span class='line'>    user.provider <span class="p">=</span> auth[<span class="s2">&quot;provider&quot;</span>]
</span><span class='line'>    user.nickname <span class="p">=</span> auth[<span class="s2">&quot;info&quot;</span>][<span class="s2">&quot;nickname&quot;</span>]
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要修改一下layout才可以看到登录成功的提示</p>

<figure class='code'><figcaption><span>app/views/layouts/application.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="p">&lt;</span>div class<span class="p">=</span><span class="s2">&quot;container&quot;</span> style<span class="p">=</span><span class="s2">&quot;margin-top: 60px;&quot;</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>% flash.each <span class="k">do</span> <span class="p">|</span>name<span class="p">,</span> msg<span class="p">|</span> %<span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span>div class<span class="p">=</span><span class="s2">&quot;alert alert-&lt;%= name == :notice ? &quot;</span>success<span class="s2">&quot; : &quot;</span>error<span class="s2">&quot; %&gt;&quot;</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="k">a</span> class<span class="p">=</span><span class="s2">&quot;close&quot;</span> data<span class="p">-</span>dismiss<span class="p">=</span><span class="s2">&quot;alert&quot;</span><span class="p">&gt;</span><span class="k">x</span><span class="p">&lt;</span>/<span class="k">a</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span>%<span class="p">=</span> msg  %<span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span>/div<span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>% <span class="k">end</span> %<span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>%<span class="p">=</span> yield %<span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span>/div<span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在登录已经成功了,我们还需要修改一下github登录的link,让它登录后显示用户名和logout</p>

<p>首先我们需要定义一个帮助方法来判断用户有没登录</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'>class ApplicationController <span class="p">&lt;</span> ActionController::Base
</span><span class='line'>
</span><span class='line'>  protect_from_forgery with: :exception
</span><span class='line'>  helper_method :current_user
</span><span class='line'>
</span><span class='line'>  private
</span><span class='line'>
</span><span class='line'>    <span class="nb">def</span> current_user
</span><span class='line'>      @current_user <span class="p">||=</span> <span class="nb">User</span>.find<span class="p">(</span>session[:user_id]<span class="p">)</span> <span class="k">if</span> session[:user_id]
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后定义一条logout的路由</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="k">get</span> <span class="s2">&quot;signout&quot;</span> <span class="p">=&gt;</span> <span class="s2">&quot;sessions#destroy&quot;</span><span class="p">,</span> :<span class="k">as</span> <span class="p">=&gt;</span> <span class="s2">&quot;signout&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>以及对应的Action</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="nb">def</span> destroy
</span><span class='line'>  session[:user_id] <span class="p">=</span> nil
</span><span class='line'>  redirect_to root_url<span class="p">,</span> :notice <span class="p">=&gt;</span> <span class="s2">&quot;Signed out!&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后修改layout</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='vim'><span class='line'><span class="p">&lt;</span>div class<span class="p">=</span><span class="s2">&quot;user-nav pull-right&quot;</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>% <span class="k">if</span> current_user %<span class="p">&gt;</span>
</span><span class='line'>    Welcome <span class="p">&lt;</span>%<span class="p">=</span> current_user.nickname %<span class="p">&gt;!</span>
</span><span class='line'>    <span class="p">&lt;</span>%<span class="p">=</span> link_to <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> signout_path %<span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>% <span class="k">else</span> %<span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span>%<span class="p">=</span> link_to <span class="s2">&quot;Github Login&quot;</span><span class="p">,</span> <span class="s2">&quot;/auth/github&quot;</span> %<span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span>% <span class="k">end</span> %<span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span>/div<span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>基本上这样就算完成了</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/19/from-git-push-to-commit-show-on-page/">Gitlab Shell如何工作</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/17/meta-ruby-note/">Ruby元编程读书笔记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/22/build-rails-dev-env-using-docker/">使用Docker搭建一个Rails开发环境</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/14/how-docker-image-works-with-aufs/">理解Docker镜像的存储原理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/07/2014-conclusion-and-2015-plan/">2014年总结 && 2015年展望</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/10/memcached-cache-analysis/">Memcached Cache Analysis</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/22/login-from-console/">Login From Console</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/11/learning-chef-ohai-source-code/">Chef Ohai源码学习</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/williamherry">@williamherry</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'williamherry',
            count: 6,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - William Herry -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'williamherry';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>






  <script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fb7d5e56d88d60f662ac5925d6ef11e5b' type='text/javascript'%3E%3C/script%3E"));
  </script>
</body>
</html>
